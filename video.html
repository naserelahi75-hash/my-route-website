<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <title>آپلود و کاهش حجم ویدئو</title>
  <style>
    body { font-family: Tahoma, sans-serif; background:#f5f5f5; padding:20px }
    .dropzone {
      border: 2px dashed #888;
      padding: 30px;
      text-align: center;
      background: #fff;
      cursor: pointer;
      margin-bottom: 20px;
    }
    .dropzone.dragover { border-color: #28a745; background:#eefaf1 }
    video { max-width:100%; margin-top:15px; border:1px solid #ccc }
    .controls { margin-top: 20px }
    label { display:block; margin-top:10px }
    button { margin-top:15px; padding:8px 16px }
    progress { width:100%; height:20px }
  </style>
</head>
<body>

<h2>آپلود و کاهش حجم ویدئو (Client Side)</h2>

<div class="dropzone" id="dropzone">
  ویدئو را بکشید و اینجا رها کنید یا کلیک کنید
  <input type="file" id="fileInput" accept="video/*" hidden>
</div>

<video id="video" controls></video>

<div class="controls">
  <label>
    کیفیت خروجی (Bitrate تقریبی):
    <select id="bitrate">
      <option value="500000">کم (500 kbps)</option>
      <option value="1000000" selected>متوسط (1 Mbps)</option>
      <option value="2500000">بالا (2.5 Mbps)</option>
    </select>
  </label>

  <button id="compressBtn">کاهش حجم و ذخیره</button>
  <progress id="progress" value="0" max="100" hidden></progress>
</div>

<script>
const dropzone = document.getElementById('dropzone');
const fileInput = document.getElementById('fileInput');
const video = document.getElementById('video');
const compressBtn = document.getElementById('compressBtn');
const bitrateSelect = document.getElementById('bitrate');
const progress = document.getElementById('progress');

let file;

// Drag & Drop
dropzone.addEventListener('click', () => fileInput.click());

dropzone.addEventListener('dragover', e => {
  e.preventDefault();
  dropzone.classList.add('dragover');
});

dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));

dropzone.addEventListener('drop', e => {
  e.preventDefault();
  dropzone.classList.remove('dragover');
  loadFile(e.dataTransfer.files[0]);
});

fileInput.addEventListener('change', e => loadFile(e.target.files[0]));

function loadFile(f) {
  if (!f) return;
  file = f;
  video.src = URL.createObjectURL(file);
}

compressBtn.addEventListener('click', async () => {
  if (!file) {
    alert('ابتدا یک ویدئو انتخاب کنید');
    return;
  }

  if (!('MediaRecorder' in window)) {
    alert('مرورگر شما از فشرده‌سازی ویدئو پشتیبانی نمی‌کند');
    return;
  }

  const stream = video.captureStream();
  const bitrate = parseInt(bitrateSelect.value);

  const recorder = new MediaRecorder(stream, {
    mimeType: 'video/webm',
    videoBitsPerSecond: bitrate
  });

  let chunks = [];
  recorder.ondataavailable = e => chunks.push(e.data);

  recorder.onstop = () => {
    const blob = new Blob(chunks, { type: 'video/webm' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = 'compressed-video.webm';
    a.click();

    progress.hidden = true;
  };

  progress.hidden = false;
  progress.value = 0;

  recorder.start();
  video.play();

  const duration = video.duration * 1000;

  let elapsed = 0;
  const timer = setInterval(() => {
    elapsed += 200;
    progress.value = Math.min(100, (elapsed / duration) * 100);
  }, 200);

  setTimeout(() => {
    clearInterval(timer);
    recorder.stop();
    video.pause();
  }, duration);
});
</script>

</body>
</html>
