<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>Ø³Ø§Ù…Ø§Ù†Ù‡ Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª ÙØ±ÙˆØ´Ú¯Ø§Ù‡â€ŒÙ‡Ø§</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body{margin:0;font-family:tahoma;background:#0f172a;color:#fff}
#map{height:100vh}
.panel{position:absolute;top:10px;right:10px;width:360px;max-height:95vh;overflow:auto;background:#020617cc;padding:15px;border-radius:12px;z-index:999}
input,select,button{width:100%;margin-top:6px;padding:8px;border-radius:6px;border:none;font-size:13px}
button{background:#2563eb;color:#fff;cursor:pointer}
hr{border:1px solid #1e293b;margin:10px 0}
table{width:100%;border-collapse:collapse;font-size:12px;margin-top:10px}
th,td{border:1px solid #334155;padding:4px;text-align:center}
th{background:#020617}
</style>
</head>
<body>

<div class="panel">
  <h3>ğŸ“‚ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±ÙˆØ´Ú¯Ø§Ù‡â€ŒÙ‡Ø§</h3>
  <input type="file" id="excelFile" accept=".xlsx,.xls" />

  <hr>

  <h3>ğŸ” Ø¬Ø³ØªØ¬Ùˆ ÙØ±ÙˆØ´Ú¯Ø§Ù‡</h3>
  <input id="searchCode" placeholder="Ú©Ø¯ ÙØ±ÙˆØ´Ú¯Ø§Ù‡" oninput="filterStores()">
  <input id="searchCity" placeholder="Ø´Ù‡Ø±" oninput="filterStores()">
  <input id="searchManager" placeholder="Ù…Ø³Ø¦ÙˆÙ„ Ù…Ù†Ø·Ù‚Ù‡" oninput="filterStores()">

  <select id="storeSelect"></select>

  <hr>

  <h3>ğŸ­ Ø§Ù†Ø¨Ø§Ø± (ÙØ¹Ù„Ø§Ù‹ Ø¯Ø³ØªÛŒ)</h3>
  <input id="warehouseCoord" placeholder="lat,lng Ø§Ù†Ø¨Ø§Ø±">

  <button onclick="routeTruck()">ğŸš› Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø³ÛŒØ± Ú©Ø§Ù…ÛŒÙˆÙ†</button>

  <table id="resultTable" style="display:none">
    <thead>
      <tr>
        <th>Ú©Ø¯</th><th>Ø´Ù‡Ø±</th><th>Ù…Ø³Ø¦ÙˆÙ„</th><th>km</th><th>min</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="map"></div>

<script>
const API_KEY = "service.2b2bc79d99084f40be64ee8e482a45ef";
let stores=[];

const map=L.map('map').setView([32.5,51.7],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
let routeLine;

excelFile.onchange=e=>{
  const reader=new FileReader();
  reader.onload=evt=>{
    const wb=XLSX.read(evt.target.result,{type:'binary'});
    const data=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
    stores=data.map(r=>{
      const coord=(r[Object.keys(r).find(k=>String(r[k]).includes(','))]||'').split(',');
      return{
        code:r['Ú©Ø¯ ÙØ±ÙˆØ´Ú¯Ø§Ù‡']||r['store_code']||'',
        city:r['Ø´Ù‡Ø±']||r['Ù…Ù†Ø·Ù‚Ù‡']||'',
        manager:r['Ù…Ø³Ø¦ÙˆÙ„ Ù…Ù†Ø·Ù‚Ù‡']||r['Ù…Ø³Ø¦ÙˆÙ„']||'',
        lat:parseFloat(coord[0]),
        lng:parseFloat(coord[1])
      }
    }).filter(s=>s.lat&&s.lng);
    filterStores();
    alert('ÙØ±ÙˆØ´Ú¯Ø§Ù‡â€ŒÙ‡Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯: '+stores.length);
  };
  reader.readAsBinaryString(e.target.files[0]);
};

function filterStores(){
  const c=searchCode.value.toLowerCase();
  const city=searchCity.value.toLowerCase();
  const m=searchManager.value.toLowerCase();
  storeSelect.innerHTML='';
  stores.filter(s=>
    s.code.toString().includes(c)&&
    s.city.toLowerCase().includes(city)&&
    s.manager.toLowerCase().includes(m)
  ).forEach((s,i)=>{
    const opt=document.createElement('option');
    opt.value=i;
    opt.textContent=`${s.code} | ${s.city} | ${s.manager}`;
    storeSelect.appendChild(opt);
  });
}

async function routeTruck(){
  if(!storeSelect.value){alert('ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†');return;}
  if(!warehouseCoord.value){alert('Ù…Ø®ØªØµØ§Øª Ø§Ù†Ø¨Ø§Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†');return;}

  const s=stores[storeSelect.value];
  const origin=warehouseCoord.value;
  const destination=`${s.lat},${s.lng}`;

  const url=`https://api.neshan.org/v4/direction?type=truck&origin=${origin}&destination=${destination}`;
  const res=await fetch(url,{headers:{'Api-Key':API_KEY}});
  const data=await res.json();

  const coords=data.routes[0].legs[0].steps.flatMap(st=>st.polyline.map(p=>[p[1],p[0]]));
  if(routeLine)map.removeLayer(routeLine);
  routeLine=L.polyline(coords,{color:'orange',weight:6}).addTo(map);
  map.fitBounds(routeLine.getBounds());

  const dist=(data.routes[0].distance/1000).toFixed(1);
  const dur=Math.round(data.routes[0].duration/60);

  resultTable.style.display='table';
  resultTable.querySelector('tbody').innerHTML=`<tr><td>${s.code}</td><td>${s.city}</td><td>${s.manager}</td><td>${dist}</td><td>${dur}</td></tr>`;
}
</script>
</body>
</html>
