<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>محاسبه بهره‌وری</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body { font-family: Tahoma; direction: rtl; padding: 20px; }
table { border-collapse: collapse; width: 100%; font-size: 12px; margin-top:20px;}
th,td { border:1px solid #ccc; padding:6px; text-align:center;}
th { background:#eee; }
</style>
</head>

<body>

<h2>محاسبه بهره‌وری (پاداش)</h2>

<input type="file" id="file" accept=".xlsx">
<button onclick="run()">محاسبه</button>
<button onclick="download()">دانلود خروجی</button>

<table id="tbl"></table>

<script>
let output = [];

function run() {
    const file = document.getElementById("file").files[0];
    if (!file) return alert("فایل را انتخاب کن");

    const reader = new FileReader();
    reader.onload = e => {
        const wb = XLSX.read(e.target.result, {type:"array"});
        const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        calculate(rows);
        render();
    };
    reader.readAsArrayBuffer(file);
}

function calculate(rows) {

    // میانگین بهره‌وری برای پرسنل جدید
    const avg = {};
    rows.forEach(r=>{
        const key = r["سمت عملیاتی"]+"_"+r["منطقه"];
        if(!avg[key]) avg[key]=[];
        if(Number(r["بهره‌وری ماه قبل"])>0)
            avg[key].push(Number(r["بهره‌وری ماه قبل"]));
    });

    const avgFinal = {};
    Object.keys(avg).forEach(k=>{
        avgFinal[k]=avg[k].reduce((a,b)=>a+b,0)/avg[k].length;
    });

    output = rows.map(r=>{
        let prevProd = Number(r["بهره‌وری ماه قبل"]);
        let prevDays = r["تردد ماه قبل"];

        // پرسنل جدید
        if (prevDays === "پرسنل جدید" || !prevProd) {
            const key = r["سمت عملیاتی"]+"_"+r["منطقه"];
            prevProd = avgFinal[key] || 0;
            prevDays = r["تعداد روز کاری ماه جاری"];
        }

        prevDays = Number(prevDays);
        const currDays = Number(r["تعداد روز کاری ماه جاری"]);
        const factor = Number(r["ضریب بهره‌وری"]);
        const otPrev = Number(r["اضافه کاری ماه قبل"]) || 0;
        const otNow = Number(r["اضافه کاری ماه جاری"]) || 0;

        let base = (prevProd / prevDays) * currDays * factor;

        let otEffect = 1;
        if (otPrev > 0)
            otEffect += ((otNow - otPrev) / otPrev) * 0.25;

        const final = Math.round(base * otEffect);

        return {
            ...r,
            "بهره‌وری نهایی": final
        };
    });
}

function render() {
    const t=document.getElementById("tbl");
    t.innerHTML="";
    const h=Object.keys(output[0]);
    t.innerHTML+="<tr>"+h.map(x=>`<th>${x}</th>`).join("")+"</tr>";
    output.forEach(r=>{
        t.innerHTML+="<tr>"+h.map(x=>`<td>${r[x]}</td>`).join("")+"</tr>";
    });
}

function download() {
    const ws=XLSX.utils.json_to_sheet(output);
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,"Result");
    XLSX.writeFile(wb,"بهره‌وری_نهایی.xlsx");
}
</script>

</body>
</html>
