<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>naser.ir | Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ ÙˆØ§Ù‚Ø¹ÛŒ Ú©Ø§Ù…ÛŒÙˆÙ†</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body{margin:0;font-family:tahoma;background:#0b1220;color:#fff}
#login,#app{display:none;height:100vh}
#login{display:flex;align-items:center;justify-content:center}
.box{background:#111a2e;padding:30px;border-radius:10px;width:300px}
input,button{width:100%;padding:10px;margin-top:10px;border:none;border-radius:5px}
button{background:#2563eb;color:#fff;cursor:pointer}
#app{display:flex}
#panel{width:340px;padding:15px;background:#0f172a;overflow:auto}
#map{flex:1}
.store{padding:8px;border-bottom:1px solid #333;cursor:pointer}
.store:hover{background:#1e293b}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login">
 <div class="box">
  <h3 style="text-align:center">naser.ir</h3>
  <input id="user" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ">
  <input id="pass" type="password" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
  <button onclick="login()">ÙˆØ±ÙˆØ¯</button>
 </div>
</div>

<!-- APP -->
<div id="app">
 <div id="panel">
  <h3>ğŸ“ Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ù†Ø¨Ø§Ø± (Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡)</h3>
  <div id="whText">Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡</div>

  <hr>

  <h3>ğŸ” Ø¬Ø³ØªØ¬ÙˆÛŒ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ (Ú©Ø¯ Ø§Ù„Ø²Ø§Ù…ÛŒ)</h3>
  <input id="search" placeholder="Ú©Ø¯ ÙØ±ÙˆØ´Ú¯Ø§Ù‡">

  <div id="stores"></div>
 </div>

 <div id="map"></div>
</div>

<script>
/* ================= CONFIG ================= */
const CONFIG={
 neshanKey:"PUT_YOUR_NESHAN_API_KEY"
};

const USERS={ naser:"12345" };

/* ================= LOGIN ================= */
if(localStorage.getItem("login")==="ok"){
 document.getElementById("login").style.display="none";
 document.getElementById("app").style.display="flex";
 init();
}else{
 document.getElementById("login").style.display="flex";
}

function login(){
 const u=user.value,p=pass.value;
 if(USERS[u]===p){
  localStorage.setItem("login","ok");
  location.reload();
 }else alert("ÛŒÙˆØ²Ø± ÛŒØ§ Ù¾Ø³ÙˆØ±Ø¯ Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª");
}

document.addEventListener("keydown",e=>{
 if(e.key==="Enter" && login.style.display==="flex") login();
});

/* ================= DATA (STATIC) ================= */
const STORES=[
 {code:"1008",city:"ØªÙ‡Ø±Ø§Ù†",manager:"Ø§Ø­Ù…Ø¯ÛŒ",lat:35.72,lng:51.42},
 {code:"1010",city:"Ú©Ø±Ø¬",manager:"Ù…Ø­Ù…Ø¯ÛŒ",lat:35.83,lng:50.97},
 {code:"1020",city:"Ù‚Ù…",manager:"Ø±Ø¶Ø§ÛŒÛŒ",lat:34.64,lng:50.88}
];

/* ================= MAP ================= */
let map,warehouse,whMarker,routeLine;

function init(){
 map=L.map("map").setView([35.7,51.4],8);
 L.tileLayer("https://static.neshan.org/sdk/leaflet/v1/tiles/default/{z}/{x}/{y}.png",{
  maxZoom:18
 }).addTo(map);

 map.on("click",e=>{
  warehouse=e.latlng;
  if(whMarker) map.removeLayer(whMarker);
  whMarker=L.marker(e.latlng).addTo(map).bindPopup("Ø§Ù†Ø¨Ø§Ø±").openPopup();
  whText.innerText=`${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`;
 });

 renderStores();
 search.oninput=renderStores;
}

/* ================= STORES ================= */
function renderStores(){
 stores.innerHTML="";
 const q=search.value.trim();
 STORES.filter(s=>!q||s.code.includes(q)).forEach(s=>{
  const d=document.createElement("div");
  d.className="store";
  d.innerText=`${s.code} | ${s.city} | ${s.manager}`;
  d.onclick=()=>showStore(s);
  stores.appendChild(d);
 });
}

function showStore(s){
 if(!warehouse){ alert("Ø§ÙˆÙ„ Ø§Ù†Ø¨Ø§Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†"); return; }

 const marker=L.marker([s.lat,s.lng]).addTo(map);
 map.setView([s.lat,s.lng],12);

 const url=`https://api.neshan.org/v4/direction?origin=${warehouse.lat},${warehouse.lng}&destination=${s.lat},${s.lng}&vehicle=truck`;

 fetch(url,{headers:{"Api-Key":CONFIG.neshanKey}})
 .then(r=>r.json())
 .then(d=>{
  const leg=d.routes[0].legs[0];
  const km=(leg.distance.value/1000)*2;

  marker.bindPopup(`
   <b>Ú©Ø¯:</b> ${s.code}<br>
   <b>Ø´Ù‡Ø±:</b> ${s.city}<br>
   <b>Ù…Ø³Ø¦ÙˆÙ„:</b> ${s.manager}<br>
   <b>Ø±ÙØª Ùˆ Ø¨Ø±Ú¯Ø´Øª:</b> ${km.toFixed(1)} km<br>
   <b>Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØªØ±ÛŒÙ† Ù…Ø³ÛŒØ±:</b> Ú©ÙˆØªØ§Ù‡â€ŒØªØ±ÛŒÙ† Ù…Ø³ÛŒØ± Ø¬Ø§Ø¯Ù‡â€ŒØ§ÛŒ
  `).openPopup();

  if(routeLine) map.removeLayer(routeLine);
  routeLine=L.polyline(leg.steps.flatMap(st=>st.polyline),{weight:5}).addTo(map);
 });
}
</script>
</body>
</html>
