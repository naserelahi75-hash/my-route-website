<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<title>محاسبه بهره‌وری (پاداش)</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body{font-family:tahoma;background:#f5f6f8;margin:20px}
h2{margin-bottom:10px}
input,button{padding:6px;margin:3px}
table{border-collapse:collapse;width:100%;background:#fff}
th,td{border:1px solid #ccc;padding:6px;font-size:13px;text-align:center}
th{background:#eee}

.up{color:#0a8f3c;font-weight:bold}
.down{color:#c62828;font-weight:bold}
.same{color:#555}
.new{color:#1565c0;font-weight:bold}
</style>
</head>

<body>

<h2>محاسبه بهره‌وری (پاداش)</h2>

سقف بودجه (ریال):
<input id="budget" type="number" value="1800000000">
<input type="file" id="file">
<button onclick="calc()">محاسبه</button>
<button onclick="download()">دانلود خروجی</button>

<div id="out"></div>

<script>
let finalRows=[];
const NEW_BASE_RATE = 2500; // نرخ پایه پرسنل جدید

function num(v){
  v=Number(String(v).replace(/,/g,''));
  return isNaN(v)?0:v;
}

function noDecimal(n){
  return Math.round(n);
}

function calc(){
  const f=document.getElementById('file').files[0];
  if(!f){alert("فایل را انتخاب کنید");return;}

  const r=new FileReader();
  r.onload=e=>{
    const wb=XLSX.read(e.target.result,{type:'binary'});
    const ws=wb.Sheets[wb.SheetNames[0]];
    const rows=XLSX.utils.sheet_to_json(ws,{header:1});

    finalRows=[];
    let total=0;

    for(let i=1;i<rows.length;i++){
      const row=rows[i];

      const name=row[1];
      const prevProd=num(row[2]);
      const currOT=num(row[3]);
      const prevOT=num(row[4]);
      const factor=num(row[5])||1;

      let finalProd=0;
      let status="same";

      if(prevProd===0){
        finalProd=currOT*factor*NEW_BASE_RATE;
        status="new";
      }else{
        let base=(prevProd/(prevOT||1))*currOT*factor;
        let delta=(currOT-(prevOT||currOT))/(prevOT||currOT);

        let adjust=1;
        if(delta>0) adjust=1-Math.min(delta*0.4,0.3);
        if(delta<0) adjust=1+Math.min(Math.abs(delta)*0.3,0.25);

        finalProd=base*adjust;

        if(finalProd>prevProd) status="up";
        else if(finalProd<prevProd) status="down";
      }

      finalProd=noDecimal(finalProd);
      const diff=noDecimal(finalProd-prevProd);

      total+=finalProd;

      finalRows.push([
        name,
        prevProd,
        currOT,
        prevOT,
        factor,
        diff,
        finalProd,
        status
      ]);
    }

    const budget=num(document.getElementById('budget').value);
    if(total>budget){
      const scale=budget/total;
      total=0;
      finalRows=finalRows.map(r=>{
        r[6]=noDecimal(r[6]*scale);
        r[5]=noDecimal(r[6]-r[1]);
        total+=r[6];
        return r;
      });
    }

    render();
  };
  r.readAsBinaryString(f);
}

function render(){
  let h='<table><tr>'+
    '<th>نام</th>'+
    '<th>بهروری قبل</th>'+
    '<th>اضافه‌کاری جاری</th>'+
    '<th>اضافه‌کاری قبل</th>'+
    '<th>ضریب</th>'+
    '<th>تغییر بهره‌وری</th>'+
    '<th>بهروری نهایی</th>'+
    '</tr>';

  finalRows.forEach(r=>{
    h+=`<tr class="${r[7]}">
      <td>${r[0]}</td>
      <td>${r[1].toLocaleString()}</td>
      <td>${r[2].toLocaleString()}</td>
      <td>${r[3].toLocaleString()}</td>
      <td>${r[4]}</td>
      <td>${r[5].toLocaleString()}</td>
      <td>${r[6].toLocaleString()}</td>
    </tr>`;
  });

  h+='</table>';
  document.getElementById('out').innerHTML=h;
}

function download(){
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.aoa_to_sheet([
    ['نام','بهروری قبل','اضافه‌کاری جاری','اضافه‌کاری قبل','ضریب','تغییر','بهروری نهایی'],
    ...finalRows.map(r=>r.slice(0,7))
  ]);
  XLSX.utils.book_append_sheet(wb,ws,'Result');
  XLSX.writeFile(wb,'productivity_final.xlsx');
}
</script>

</body>
</html>
