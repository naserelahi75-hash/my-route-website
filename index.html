<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>naser.ir</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body{margin:0;font-family:tahoma;background:#111;color:#fff}
#login,#app{height:100vh}
#login{display:flex;align-items:center;justify-content:center}
.box{background:#1e1e1e;padding:30px;border-radius:10px;width:300px}
input,button{width:100%;padding:8px;margin:5px 0}
#app{display:none}
#sidebar{width:320px;background:#0b1220;padding:10px;overflow:auto}
#map{flex:1}
.flex{display:flex;height:100%}
table{width:100%;font-size:12px}
td,th{border-bottom:1px solid #333;padding:4px}
.selected{background:#224}
</style>
</head>

<body>

<div id="login">
  <div class="box">
    <h3>ÙˆØ±ÙˆØ¯</h3>
    <input id="user" placeholder="user">
    <input id="pass" placeholder="password" type="password">
    <button onclick="login()">ÙˆØ±ÙˆØ¯</button>
  </div>
</div>

<div id="app" class="flex">
  <div id="sidebar">
    ğŸ“ <b>Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ù†Ø¨Ø§Ø± (Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡)</b>
    <div id="warehouseText"></div>
    <hr>

    ğŸ” <input id="search" placeholder="Ø¬Ø³ØªØ¬Ùˆ..." oninput="renderList()">

    <button onclick="calcRoute()">ğŸ“ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø³ÛŒØ±</button>
    <div id="distance"></div>

    <table>
      <thead>
        <tr><th>âœ”</th><th>Ú©Ø¯</th><th>Ù†Ø§Ù…</th><th>Ø´Ù‡Ø±</th></tr>
      </thead>
      <tbody id="list"></tbody>
    </table>
  </div>

  <div id="map"></div>
</div>

<script>
/* ================= ØªÙ†Ø¸ÛŒÙ…Ø§Øª ================= */
const API_KEY = "YOUR_NESHAN_API_KEY";

/* ÛŒÙˆØ²Ø± Ù¾Ø³ÙˆØ±Ø¯ (Ù‚Ø§Ø¨Ù„ ØªØºÛŒÛŒØ±) */
const AUTH = { user:"naser", pass:"12345" };

/* Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±ÙˆØ´Ú¯Ø§Ù‡â€ŒÙ‡Ø§ â€“ ÙÙ‚Ø· Ø§ÛŒÙ†Ùˆ Ø¢Ù¾Ø¯ÛŒØª Ú©Ù† */
const STORES = [
 {id:1008,name:"Ø§Ø­Ù…Ø¯ÛŒ",city:"ØªÙ‡Ø±Ø§Ù†",manager:"-",lat:35.72,lng:51.41},
 {id:1010,name:"Ú©Ø±ÛŒÙ…ÛŒ",city:"Ú©Ø±Ø¬",manager:"-",lat:35.83,lng:50.99}
];

/* ================= Ù„Ø§Ú¯ÛŒÙ† ================= */
if(localStorage.login==="1") showApp();

function login(){
 if(user.value===AUTH.user && pass.value===AUTH.pass){
   localStorage.login="1";
   showApp();
 }else alert("Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙˆØ±ÙˆØ¯ Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª");
}

function showApp(){
 login.style.display="none";
 app.style.display="flex";
 initMap();
}

/* ================= Ù†Ù‚Ø´Ù‡ ================= */
let map, warehouse=null, markers=[], selected=[];

function initMap(){
 map = L.map('map').setView([35.7,51.4],10);

 L.tileLayer(
 'https://static.neshan.org/sdk/leaflet/v1/tiles/default/{z}/{x}/{y}.png',
 {maxZoom:19}
 ).addTo(map);

 map.on("click",e=>{
   warehouse=e.latlng;
   L.marker(e.latlng).addTo(map).bindPopup("Ø§Ù†Ø¨Ø§Ø±").openPopup();
   warehouseText.innerText=`${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`;
 });
 renderList();
}

/* ================= Ù„ÛŒØ³Øª ================= */
function renderList(){
 list.innerHTML="";
 const q=search.value||"";
 STORES.filter(s=>
  Object.values(s).join("").includes(q)
 ).forEach(s=>{
   const tr=document.createElement("tr");
   tr.innerHTML=`
    <td><input type="checkbox" onchange="toggle(${s.id},this)"></td>
    <td>${s.id}</td><td>${s.name}</td><td>${s.city}</td>`;
   list.appendChild(tr);

   const m=L.marker([s.lat,s.lng]).addTo(map)
    .bindPopup(`<b>${s.name}</b><br>${s.city}`);
   markers.push(m);
 });
}

function toggle(id,el){
 const s=STORES.find(x=>x.id===id);
 if(el.checked) selected.push(s);
 else selected=selected.filter(x=>x.id!==id);
}

/* ================= Ù…Ø³ÛŒØ± ================= */
async function calcRoute(){
 if(!warehouse||selected.length===0) return alert("Ø§Ù†Ø¨Ø§Ø± ÛŒØ§ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡");

 let points=[warehouse,...selected.map(s=>({lat:s.lat,lng:s.lng})),warehouse];

 const url=`https://api.neshan.org/v4/direction?type=car&origin=${points[0].lat},${points[0].lng}&destination=${points.at(-1).lat},${points.at(-1).lng}&waypoints=${points.slice(1,-1).map(p=>p.lat+","+p.lng).join("|")}`;

 const r=await fetch(url,{headers:{"Api-Key":API_KEY}});
 const j=await r.json();

 const km=(j.routes[0].legs.reduce((a,b)=>a+b.distance.value,0)/1000).toFixed(1);
 distance.innerText=`Ù…Ø³Ø§ÙØª Ø±ÙØªâ€ŒÙˆØ¨Ø±Ú¯Ø´Øª: ${km} km`;
}
</script>

</body>
</html>
