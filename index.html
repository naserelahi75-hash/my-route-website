<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>محاسبه بهره‌وری</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<style>
body {
  font-family: Tahoma;
  direction: rtl;
  padding: 20px;
}
table {
  border-collapse: collapse;
  width: 100%;
  margin-top: 15px;
}
th, td {
  border: 1px solid #999;
  padding: 6px;
  text-align: center;
}
th {
  background: #f2f2f2;
}
#budget {
  margin-top: 15px;
  font-size: 18px;
  font-weight: bold;
  color: green;
}
</style>
</head>

<body>

<h2>سیستم محاسبه بهره‌وری</h2>

<input type="file" id="fileInput" />
<button onclick="exportExcel()">خروجی اکسل</button>

<div id="budget"></div>
<div id="table"></div>

<script>
let finalData = [];

function toNumber(v) {
  if (v === undefined || v === null || v === "") return 0;
  return Number(String(v).replace(/,/g, ""));
}

document.getElementById("fileInput").addEventListener("change", function(e) {
  const file = e.target.files[0];
  const reader = new FileReader();

  reader.onload = function(evt) {
    const data = new Uint8Array(evt.target.result);
    const workbook = XLSX.read(data, { type: "array" });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet);

    calculate(rows);
    renderTable(finalData);
  };

  reader.readAsArrayBuffer(file);
});

function calculate(rows) {
  let totalBudget = 0;
  finalData = [];

  rows.forEach(r => {
    const prevProductivity = toNumber(r["بهره‌وری ماه قبل"]);
    const workDays = toNumber(r["تعداد روز کاری ماه جاری"]);
    const factor = toNumber(r["ضریب بهره‌وری"]);
    const otPrev = toNumber(r["اضافه کاری ماه قبل"]);
    const otCurrent = toNumber(r["اضافه کاری ماه جاری"]);
    const rate = toNumber(r["نرخ محاسبه"]);

    const base =
      (prevProductivity / 30) * workDays * factor;

    const otEffect =
      (otPrev - otCurrent) * rate;

    const finalValue = Math.round(base + otEffect);

    r["محاسبه بهره‌وری ماه جدید"] = finalValue;
    totalBudget += finalValue;
    finalData.push(r);
  });

  document.getElementById("budget").innerText =
    "جمع کل بودجه بهره‌وری: " + totalBudget.toLocaleString();
}

function renderTable(data) {
  if (data.length === 0) return;

  let html = "<table><tr>";
  Object.keys(data[0]).forEach(k => {
    html += "<th>" + k + "</th>";
  });
  html += "</tr>";

  data.forEach(r => {
    html += "<tr>";
    Object.values(r).forEach(v => {
      html += "<td>" + (v ?? "") + "</td>";
    });
    html += "</tr>";
  });

  html += "</table>";
  document.getElementById("table").innerHTML = html;
}

function exportExcel() {
  if (finalData.length === 0) {
    alert("داده‌ای برای خروجی وجود ندارد");
    return;
  }
  const ws = XLSX.utils.json_to_sheet(finalData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Result");
  XLSX.writeFile(wb, "نتیجه_بهره_وری.xlsx");
}
</script>

</body>
</html>
