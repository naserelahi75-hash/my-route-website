<script>
function toNumber(v) {
  if (v === undefined || v === null || v === "" || isNaN(v)) return 0;
  return Number(String(v).replace(/,/g, ""));
}

function calculate(rows) {
  let totalBudget = 0;

  rows.forEach(r => {
    const prevProductivity = toNumber(r["بهره‌وری ماه قبل"]);
    const workDays = toNumber(r["تعداد روز کاری ماه جاری"]);
    const factor = toNumber(r["ضریب بهره‌وری"]);
    const otPrev = toNumber(r["اضافه کاری ماه قبل"]);
    const otCurrent = toNumber(r["اضافه کاری ماه جاری"]);
    const rate = toNumber(r["نرخ محاسبه"]);

    // بهره‌وری پایه
    const daily = prevProductivity / 30;
    const base = daily * workDays * factor;

    // اثر معکوس اضافه‌کاری
    const otEffect = (otPrev - otCurrent) * rate;

    const finalValue = Math.round(base + otEffect);

    r["محاسبه بهره‌وری ماه جدید"] = finalValue;
    totalBudget += finalValue;
  });

  document.getElementById("budget").innerText =
    "جمع کل بودجه بهره‌وری: " + totalBudget.toLocaleString();

  return rows;
}
</script>
