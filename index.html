function toNumber(v) {
  if (v === undefined || v === null || v === "") return 0;
  return Number(String(v).replace(/,/g, "")) || 0;
}

function calculateProductivity(rows) {
  rows.forEach(r => {

    const prevProductivity = toNumber(r["بهره‌وری ماه قبل"]);
    const workDaysCurrent  = toNumber(r["تعداد روز کاری ماه جاری"]);
    const factor           = toNumber(r["ظریب بهره وری"]);
    const otCurrent        = toNumber(r["اضافه کاری ماه جاری"]);
    const otPrev           = toNumber(r["اضاقه کاری ماه قبل"]);
    const rate             = toNumber(r["نرخ محاسبه"]);

    // بهره‌وری پایه روزانه
    const dailyProductivity = prevProductivity / 30;

    // بهره‌وری ماه جاری
    const baseValue = dailyProductivity * workDaysCurrent * factor;

    // اثر اضافه کاری
    const otEffect = (otCurrent - otPrev) * rate;

    // مقدار نهایی
    const finalValue = baseValue + otEffect;

    r["محاسبه بهروری ماه جدید"] = Math.round(finalValue);
  });

  return rows;
}
