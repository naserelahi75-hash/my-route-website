<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨Ù‡Ø±Ù‡â€ŒÙˆØ±ÛŒ Ù¾Ø±Ø³Ù†Ù„</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: Tahoma; direction: rtl; padding: 20px }
    table { border-collapse: collapse; width: 100%; margin-top: 20px }
    th, td { border: 1px solid #ccc; padding: 6px; font-size: 13px }
    th { background: #eee }
    .total { margin-top: 15px; font-size: 16px; font-weight: bold }
  </style>
</head>
<body>

<h3>Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„ Ø¨Ù‡Ø±Ù‡â€ŒÙˆØ±ÛŒ</h3>
<input type="file" id="file" />
<button onclick="processExcel()">Ù…Ø­Ø§Ø³Ø¨Ù‡</button>
<button onclick="exportExcel()">Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„</button>

<div id="result"></div>
<div id="budget" class="total"></div>

<script>
let finalRows = [];

function toNumber(v) {
  if (v === undefined || v === null || v === "") return 0;
  return Number(String(v).replace(/,/g, "")) || 0;
}

function processExcel() {
  const file = document.getElementById("file").files[0];
  if (!file) {
    alert("ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡");
    return;
  }

  const reader = new FileReader();
  reader.onload = e => {
    const wb = XLSX.read(e.target.result, { type: "binary" });
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws, { defval: "" });

    let totalBudget = 0;

    rows.forEach(r => {
      const prev = toNumber(r["Ø¨Ù‡Ø±ÙˆØ±ÛŒ Ù…Ø§Ù‡ Ù‚Ø¨Ù„"]);
      const days = toNumber(r["ØªØ¹Ø¯Ø§Ø¯ Ø±ÙˆØ² Ú©Ø§Ø±ÛŒ Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ"]);
      const factor = toNumber(r["Ø¶Ø±ÛŒØ¨ Ø¨Ù‡Ø±Ù‡ ÙˆØ±ÛŒ"]);
      const otNow = toNumber(r["Ø§Ø¶Ø§ÙÙ‡ Ú©Ø§Ø±ÛŒ Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ"]);
      const otPrev = toNumber(r["Ø§Ø¶Ø§ÙÙ‡ Ú©Ø§Ø±ÛŒ Ù…Ø§Ù‡ Ù‚Ø¨Ù„"]);
      const rate = toNumber(r["Ù†Ø±Ø® Ù…Ø­Ø§Ø³Ø¨Ù‡"]);

      const daily = prev / 30;
      const base = daily * days * factor;
      const otEffect = (otNow - otPrev) * rate;
      const finalValue = Math.round(base + otEffect);

      r["Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨Ù‡Ø±ÙˆØ±ÛŒ Ù…Ø§Ù‡ Ø¬Ø¯ÛŒØ¯"] = finalValue;
      totalBudget += finalValue;
    });

    finalRows = rows;
    renderTable(rows);
    document.getElementById("budget").innerText =
      "ğŸ’° Ø¬Ù…Ø¹ Ú©Ù„ Ø¨ÙˆØ¯Ø¬Ù‡ Ø¨Ù‡Ø±Ù‡â€ŒÙˆØ±ÛŒ: " + totalBudget.toLocaleString();
  };

  reader.readAsBinaryString(file);
}

function renderTable(rows) {
  let html = "<table><tr>";
  Object.keys(rows[0]).forEach(k => html += `<th>${k}</th>`);
  html += "</tr>";

  rows.forEach(r => {
    html += "<tr>";
    Object.values(r).forEach(v => html += `<td>${v}</td>`);
    html += "</tr>";
  });

  html += "</table>";
  document.getElementById("result").innerHTML = html;
}

function exportExcel() {
  if (!finalRows.length) {
    alert("Ø§ÙˆÙ„ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ù†Ø¬Ø§Ù… Ø¨Ø¯Ù‡");
    return;
  }

  const ws = XLSX.utils.json_to_sheet(finalRows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Ù†ØªÛŒØ¬Ù‡ Ø¨Ù‡Ø±Ù‡â€ŒÙˆØ±ÛŒ");
  XLSX.writeFile(wb, "productivity_result.xlsx");
}
</script>

</body>
</html>
