function toNumber(v) {
  if (v === undefined || v === null || v === "") return 0;
  return Number(String(v).replace(/,/g, "")) || 0;
}

function calculateProductivity(rows) {

  // ===== 1) محاسبه میانگین بهره‌وری ماه قبل بر اساس منطقه + سمت =====
  const avgMap = {};

  rows.forEach(r => {
    const region = r["منطقه"];
    const role   = r["سمت عملیاتی"];
    const prevProd = toNumber(r["بهروری ماه قبل"]);
    const prevDays = toNumber(r["نردد ماه قبل"]);

    if (prevProd > 0 && prevDays > 0) {
      const key = region + "|" + role;
      if (!avgMap[key]) avgMap[key] = { sum: 0, count: 0 };
      avgMap[key].sum += prevProd;
      avgMap[key].count++;
    }
  });

  // ===== 2) محاسبه بهره‌وری ماه جدید =====
  rows.forEach(r => {
    const region = r["منطقه"];
    const role   = r["سمت عملیاتی"];

    let prevProd = toNumber(r["بهروری ماه قبل"]);
    let prevDays = toNumber(r["نردد ماه قبل"]);
    const currentDays = toNumber(r["تعداد روز کاری ماه جاری"]);
    const otPrev = toNumber(r["اضاقه کاری ماه قبل"]);
    const otCurrent = toNumber(r["اضافه کاری ماه جاری"]);
    const factor = toNumber(r["ظریب بهره وری"]) || 1;

    // اگر داده ماه قبل نداشت → میانگین منطقه/سمت
    if ((prevProd === 0 || prevDays === 0)) {
      const key = region + "|" + role;
      if (avgMap[key] && avgMap[key].count > 0) {
        prevProd = avgMap[key].sum / avgMap[key].count;
        prevDays = 30;
      }
    }

    // محاسبه
    const daily = prevDays > 0 ? prevProd / prevDays : 0;
    const baseValue = daily * currentDays;
    const afterFactor = baseValue * factor;

    const otChange = otCurrent - otPrev;
    const otEffect = 1 + (otChange * 0.03);

    const finalValue = afterFactor * otEffect;

    r["محاسبه بهروری ماه جدید"] = Math.round(finalValue);
  });

  return rows;
}
