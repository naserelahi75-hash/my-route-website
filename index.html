<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨Ù‡Ø±Ù‡â€ŒÙˆØ±ÛŒ (Ù¾Ø§Ø¯Ø§Ø´)</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body{font-family:tahoma;background:#f5f6f8;margin:20px}
h2{margin-bottom:10px}
input,button{padding:6px;margin:3px}
table{border-collapse:collapse;width:100%;background:#fff}
th,td{border:1px solid #ccc;padding:6px;font-size:13px;text-align:center}
th{background:#eee}

.up{color:#0a8f3c;font-weight:bold}
.down{color:#c62828;font-weight:bold}
.same{color:#555}
.new{color:#1565c0;font-weight:bold}
</style>
</head>

<body>

<h2>Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¨Ù‡Ø±Ù‡â€ŒÙˆØ±ÛŒ (Ù¾Ø§Ø¯Ø§Ø´)</h2>

Ø³Ù‚Ù Ø¨ÙˆØ¯Ø¬Ù‡ (Ø±ÛŒØ§Ù„):
<input id="budget" type="number" value="18409809418">
<input type="file" id="file">
<button onclick="calc()">Ù…Ø­Ø§Ø³Ø¨Ù‡</button>

<div id="out"></div>

<script>
const NEW_BASE_RATE = 2500;
let result=[];

function n(v){
  v=Number(String(v||0).replace(/,/g,''));
  return isNaN(v)?0:v;
}

function calc(){
  const f=document.getElementById('file').files[0];
  if(!f){alert("ÙØ§ÛŒÙ„ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†");return;}

  const r=new FileReader();
  r.onload=e=>{
    const wb=XLSX.read(e.target.result,{type:'binary'});
    const ws=wb.Sheets[wb.SheetNames[0]];
    const data=XLSX.utils.sheet_to_json(ws); // ğŸ‘ˆ Ú©Ù„ÛŒØ¯ÛŒ

    result=[];
    let total=0;

    data.forEach(row=>{
      const name=row['Ù†Ø§Ù…'] || row['Ú©Ø¯ Ù¾Ø±Ø³Ù†Ù„ÛŒ'];
      const prevProd=n(row['Ø¨Ù‡Ø±ÙˆØ±ÛŒ Ù‚Ø¨Ù„']);
      const currOT=n(row['Ø§Ø¶Ø§ÙÙ‡â€ŒÚ©Ø§Ø±ÛŒ Ø¬Ø§Ø±ÛŒ']);
      const prevOT=n(row['Ø§Ø¶Ø§ÙÙ‡â€ŒÚ©Ø§Ø±ÛŒ Ù‚Ø¨Ù„']);
      const factor=n(row['Ø¶Ø±ÛŒØ¨'])||1;

      let finalProd=0;
      let status='same';

      if(prevProd===0){
        finalProd=currOT*factor*NEW_BASE_RATE;
        status='new';
      }else{
        let base=(prevProd/(prevOT||1))*currOT*factor;
        let delta=(currOT-prevOT)/(prevOT||currOT);

        let adjust=1;
        if(delta>0) adjust=1-Math.min(delta*0.4,0.3);
        if(delta<0) adjust=1+Math.min(Math.abs(delta)*0.3,0.25);

        finalProd=base*adjust;

        if(finalProd>prevProd) status='up';
        else if(finalProd<prevProd) status='down';
      }

      finalProd=Math.round(finalProd);
      const diff=Math.round(finalProd-prevProd);

      total+=finalProd;

      result.push({name,prevProd,prevOT,currOT,factor,diff,finalProd,status});
    });

    render();
  };
  r.readAsBinaryString(f);
}

function render(){
  let h='<table><tr>'+
    '<th>Ù†Ø§Ù…</th>'+
    '<th>Ø¨Ù‡Ø±ÙˆØ±ÛŒ Ù‚Ø¨Ù„</th>'+
    '<th>Ø§Ø¶Ø§ÙÙ‡â€ŒÚ©Ø§Ø±ÛŒ Ù‚Ø¨Ù„</th>'+
    '<th>Ø§Ø¶Ø§ÙÙ‡â€ŒÚ©Ø§Ø±ÛŒ Ø¬Ø§Ø±ÛŒ</th>'+
    '<th>Ø¶Ø±ÛŒØ¨</th>'+
    '<th>ØªØºÛŒÛŒØ± Ø¨Ù‡Ø±Ù‡â€ŒÙˆØ±ÛŒ</th>'+
    '<th>Ø¨Ù‡Ø±ÙˆØ±ÛŒ Ù†Ù‡Ø§ÛŒÛŒ</th>'+
    '</tr>';

  result.forEach(r=>{
    h+=`<tr class="${r.status}">
      <td>${r.name}</td>
      <td>${r.prevProd.toLocaleString()}</td>
      <td>${r.prevOT.toLocaleString()}</td>
      <td>${r.currOT.toLocaleString()}</td>
      <td>${r.factor}</td>
      <td>${r.diff.toLocaleString()}</td>
      <td>${r.finalProd.toLocaleString()}</td>
    </tr>`;
  });

  h+='</table>';
  document.getElementById('out').innerHTML=h;
}
</script>

</body>
</html>
