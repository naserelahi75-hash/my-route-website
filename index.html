<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>naser.ir | Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ Ú©Ø§Ù…ÛŒÙˆÙ†</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
body{margin:0;font-family:tahoma;background:#0b132b;color:#fff}
#login,#app{height:100vh;display:flex;align-items:center;justify-content:center}
.card{width:380px;background:#111;border-radius:12px;padding:20px;box-shadow:0 0 20px #000}
input,button,select{width:100%;margin:6px 0;padding:10px;border-radius:8px;border:none}
button{background:#2563eb;color:#fff;cursor:pointer}
#layout{display:grid;grid-template-columns:360px 1fr;height:100vh}
#sidebar{background:#0f172a;padding:10px;overflow:auto}
#map{height:100vh}
.list{max-height:200px;overflow:auto;border:1px solid #333}
.row{padding:6px;border-bottom:1px solid #222}
.row label{cursor:pointer}
</style>
</head>
<body>

<div id="login">
  <div class="card">
    <h3>ÙˆØ±ÙˆØ¯ Ø¨Ù‡ naser.ir</h3>
    <input id="user" placeholder="username" />
    <input id="pass" type="password" placeholder="password" />
    <button onclick="login()">ÙˆØ±ÙˆØ¯</button>
  </div>
</div>

<div id="app" style="display:none">
  <div id="layout">
    <div id="sidebar">
      <h4>ğŸ“ ÙØ±ÙˆØ´Ú¯Ø§Ù‡â€ŒÙ‡Ø§ (Ø«Ø§Ø¨Øª)</h4>
      <input type="file" id="file" />

      <h4>ğŸ“ Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ù†Ø¨Ø§Ø±</h4>
      <input id="warehouseSearch" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¢Ø¯Ø±Ø³ Ø§Ù†Ø¨Ø§Ø±" />
      <button onclick="searchWarehouse()">Ø«Ø¨Øª Ø§Ù†Ø¨Ø§Ø±</button>

      <h4>ğŸ” ÙÛŒÙ„ØªØ±Ù‡Ø§</h4>
      <div id="filters"></div>

      <h4>ğŸ¬ ÙØ±ÙˆØ´Ú¯Ø§Ù‡â€ŒÙ‡Ø§</h4>
      <div class="list" id="stores"></div>

      <button onclick="route()">ğŸšš Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø³ÛŒØ±</button>
      <div id="result"></div>
    </div>
    <div id="map"></div>
  </div>
</div>

<script>
const USER='naser',PASS='12345';
let map=L.map('map').setView([35.6892,51.3890],10);
let warehouse=null,stores=[],markers=[];

function login(){
  if(user.value===USER && pass.value===PASS){
    login.style.display='none';app.style.display='block';setTimeout(()=>map.invalidateSize(),300)
  }
}
document.addEventListener('keydown',e=>{if(e.key==='Enter')login()});

L.tileLayer('https://api.neshan.org/v4/static?key=YOUR_NESHAN_KEY',{attribution:'Â© Neshan'}).addTo(map);
map.on('click',e=>{warehouse=e.latlng;L.marker(warehouse).addTo(map).bindPopup('Ø§Ù†Ø¨Ø§Ø±').openPopup()});

file.onchange=e=>{
  let r=new FileReader();
  r.onload=()=>{
    let wb=XLSX.read(r.result,{type:'binary'});
    let data=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
    stores=data;buildFilters(data);renderStores(data)
  };r.readAsBinaryString(e.target.files[0]);
}

function buildFilters(data){
  filters.innerHTML='';
  Object.keys(data[0]).forEach(k=>{
    let i=document.createElement('input');i.placeholder=k;i.oninput=()=>applyFilters();filters.appendChild(i)
  })
}
function applyFilters(){
  let f=[...filters.querySelectorAll('input')];
  let d=stores.filter(s=>f.every(i=>!i.value||String(s[i.placeholder]).includes(i.value)));
  renderStores(d)
}
function renderStores(data){
  storesDiv.innerHTML='';markers.forEach(m=>map.removeLayer(m));markers=[];
  data.forEach((s,i)=>{
    let d=document.createElement('div');d.className='row';
    d.innerHTML=`<label><input type='checkbox' data-i='${i}'> ${s.code||''} - ${s.city||''} - ${s.manager||''}</label>`;
    storesDiv.appendChild(d);
    if(s.lat&&s.lng){let m=L.marker([s.lat,s.lng]).addTo(map);markers.push(m)}
  })
}

function route(){
  if(!warehouse)return alert('Ø§Ù†Ø¨Ø§Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡');
  let sel=[...document.querySelectorAll('input[type=checkbox]:checked')].map(c=>stores[c.dataset.i]);
  let dist=0;sel.forEach(s=>{dist+=calc(warehouse.lat,warehouse.lng,s.lat,s.lng)*2});
  result.innerHTML=`Ù…Ø³Ø§ÙØª Ø±ÙØª Ùˆ Ø¨Ø±Ú¯Ø´Øª: ${dist.toFixed(1)} km`;
}
function calc(a,b,c,d){return 6371*Math.acos(Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.cos((d-b)*Math.PI/180)+Math.sin(a*Math.PI/180)*Math.sin(c*Math.PI/180))}
</script>
</body>
</html>
