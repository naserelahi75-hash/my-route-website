<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>naser.ir | Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ Ú©Ø§Ù…ÛŒÙˆÙ†</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
body{margin:0;font-family:tahoma;direction:rtl;background:#0f172a;color:#fff}
#login,#app{height:100vh}
#login{display:flex;align-items:center;justify-content:center}
.box{background:#020617;padding:20px;border-radius:10px;width:300px}
input,button{width:100%;padding:8px;margin:5px 0;border-radius:6px;border:none}
button{background:#2563eb;color:#fff;cursor:pointer}
#app{display:none;grid-template-columns:320px 1fr}
#sidebar{background:#020617;padding:10px;overflow:auto}
#map{height:100%}
.store{border-bottom:1px solid #1e293b;padding:5px}
</style>
</head>
<body>

<div id="login">
  <div class="box">
    <h3>ÙˆØ±ÙˆØ¯</h3>
    <input id="u" placeholder="user" onkeydown="if(event.key==='Enter')doLogin()">
    <input id="p" placeholder="password" type="password" onkeydown="if(event.key==='Enter')doLogin()">
    <button onclick="doLogin()">ÙˆØ±ÙˆØ¯</button>
    <div id="err" style="color:red"></div>
  </div>
</div>

<div id="app">
  <div id="sidebar">
    <h4>ğŸ“ Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ù†Ø¨Ø§Ø± (Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡)</h4>
    <div id="wh"></div>
    <hr>
    <input id="search" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ú©Ø¯ ÙØ±ÙˆØ´Ú¯Ø§Ù‡" oninput="renderStores()">
    <div id="stores"></div>
    <button onclick="calcRoute()">ğŸšš Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø³ÛŒØ±</button>
    <div id="result"></div>
  </div>
  <div id="map"></div>
</div>

<script>
/* AUTH */
const USER='naser',PASS='12345';
if(localStorage.logged==='1')showApp();
function doLogin(){if(u.value===USER&&p.value===PASS){localStorage.logged='1';showApp()}else err.innerText='Ø®Ø·Ø§'}
function showApp(){login.style.display='none';app.style.display='grid';initMap()}

/* DATA (Ø«Ø§Ø¨Øª â€“ ÙÙ‚Ø· Ø§ÛŒÙ†Ùˆ Ø¢Ù¾Ø¯ÛŒØª Ú©Ù†) */
const storesData=[
 {code:'1001',city:'ØªÙ‡Ø±Ø§Ù†',manager:'Ø§Ø­Ù…Ø¯ÛŒ',lat:35.71,lng:51.41},
 {code:'1002',city:'Ú©Ø±Ø¬',manager:'Ø±Ø¶Ø§ÛŒÛŒ',lat:35.84,lng:50.94},
 {code:'1003',city:'Ù‚Ù…',manager:'Ù…ÙˆØ³ÙˆÛŒ',lat:34.64,lng:50.88}
];

let map,warehouse=null,markers=[],selected=[];

function initMap(){
 map=L.map('map').setView([35.7,51.4],7);
 L.tileLayer('https://static.neshan.org/sdk/leaflet/v1/tiles/default/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
 map.on('click',e=>{
   warehouse=e.latlng;
   wh.innerText=`Ø§Ù†Ø¨Ø§Ø±: ${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
   L.marker(e.latlng).addTo(map).bindPopup('Ø§Ù†Ø¨Ø§Ø±').openPopup();
 });
 renderStores();
}

function renderStores(){
 markers.forEach(m=>map.removeLayer(m));markers=[];
 stores.innerHTML='';
 const q=search.value||'';
 storesData.filter(s=>s.code.includes(q)).forEach(s=>{
  const div=document.createElement('div');
  div.className='store';
  div.innerHTML=`<input type='checkbox' onchange='toggle("${s.code}")'> ${s.code} | ${s.city} | ${s.manager}`;
  stores.appendChild(div);
  const m=L.marker([s.lat,s.lng]).addTo(map).bindPopup(`${s.code}<br>${s.city}`);
  markers.push(m);
 });
}

function toggle(code){
 if(selected.includes(code))selected=selected.filter(x=>x!==code);
 else selected.push(code);
}

function dist(a,b){
 const R=6371;
 const dLat=(b.lat-a.lat)*Math.PI/180;
 const dLng=(b.lng-a.lng)*Math.PI/180;
 const x=Math.sin(dLat/2)**2+Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*Math.sin(dLng/2)**2;
 return 2*R*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

function calcRoute(){
 if(!warehouse||!selected.length)return alert('Ø§Ù†Ø¨Ø§Ø± ÛŒØ§ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡');
 let total=0;
 selected.forEach(c=>{
  const s=storesData.find(x=>x.code===c);
  total+=dist(warehouse,{lat:s.lat,lng:s.lng})*2;
 });
 result.innerHTML=`Ù…Ø³ÛŒØ± Ø¨Ù‡ÛŒÙ†Ù‡ (ØªÙ‚Ø±ÛŒØ¨ÛŒ)<br>km Ø±ÙØª Ùˆ Ø¨Ø±Ú¯Ø´Øª: ${total.toFixed(1)}`;
}
</script>
</body>
</html>
