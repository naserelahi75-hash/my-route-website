<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<title>محاسبه بهره‌وری (پاداش)</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body{font-family:tahoma;background:#f4f6f8;margin:20px}
h2{margin-bottom:10px}
input,button{padding:6px}
table{border-collapse:collapse;width:100%;background:#fff}
th,td{border:1px solid #ccc;padding:5px;font-size:13px;text-align:center}
th{background:#eee}
.good{color:green;font-weight:bold}
.bad{color:red;font-weight:bold}
</style>
</head>

<body>

<h2>محاسبه بهره‌وری (پاداش)</h2>

سقف بودجه (ریال):
<input id="budget" type="number" value="1800000000">
<input type="file" id="file">
<button onclick="calc()">محاسبه</button>
<button onclick="download()">دانلود خروجی</button>

<div id="out"></div>

<script>
let finalRows=[];

function num(v){
  v=Number(String(v).replace(/,/g,''));
  return isNaN(v)?0:v;
}

function round6(n){
  return Math.round(n/1000)*1000;
}

function calc(){
  const f=document.getElementById('file').files[0];
  if(!f){alert("فایل را انتخاب کنید");return;}

  const r=new FileReader();
  r.onload=e=>{
    const wb=XLSX.read(e.target.result,{type:'binary'});
    const ws=wb.Sheets[wb.SheetNames[0]];
    const rows=XLSX.utils.sheet_to_json(ws,{header:1});

    finalRows=[];
    let total=0;

    for(let i=1;i<rows.length;i++){
      const row=rows[i];

      const name=row[2];
      const prevProd=num(row[7]);
      const prevOT=num(row[6]);
      const currOT=num(row[9]);
      const prevDays=num(row[10])||1;
      const currDays=num(row[5])||1;
      const factor=num(row[8])||1;

      let base=(prevProd/prevDays)*currDays*factor;

      let delta=prevOT?((currOT-prevOT)/prevOT):0;
      let otFactor=1;

      if(delta>0) otFactor=1-Math.min(delta*0.4,0.3);
      if(delta<0) otFactor=1+Math.min(Math.abs(delta)*0.3,0.2);

      let final=base*otFactor;

      final=Math.max(prevProd*0.6,Math.min(final,prevProd*1.2));
      final=round6(final);

      total+=final;

      finalRows.push([
        name,
        round6(prevProd),
        round6(currOT),
        round6(prevOT),
        factor,
        final
      ]);
    }

    const budget=num(document.getElementById('budget').value);
    if(total>budget){
      const s=budget/total;
      total=0;
      finalRows=finalRows.map(r=>{
        r[5]=round6(r[5]*s);
        total+=r[5];
        return r;
      });
    }

    render();
  };
  r.readAsBinaryString(f);
}

function render(){
  let h='<table><tr><th>نام</th><th>بهروری قبل</th><th>اضافه‌کاری جاری</th><th>اضافه‌کاری قبل</th><th>ضریب</th><th>بهروری نهایی</th></tr>';
  finalRows.forEach(r=>{
    h+=`<tr>
      <td>${r[0]}</td>
      <td>${r[1].toLocaleString()}</td>
      <td>${r[2].toLocaleString()}</td>
      <td>${r[3].toLocaleString()}</td>
      <td>${r[4]}</td>
      <td class="${r[5]>=r[1]?'good':'bad'}">${r[5].toLocaleString()}</td>
    </tr>`;
  });
  h+='</table>';
  document.getElementById('out').innerHTML=h;
}

function download(){
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.aoa_to_sheet([
    ['نام','بهروری قبل','اضافه‌کاری جاری','اضافه‌کاری قبل','ضریب','بهروری نهایی'],
    ...finalRows
  ]);
  XLSX.utils.book_append_sheet(wb,ws,'Result');
  XLSX.writeFile(wb,'productivity_final.xlsx');
}
</script>

</body>
</html>
