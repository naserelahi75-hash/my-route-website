<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>سیستم محاسبه پاداش پرسنل</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<style>
body { font-family: Tahoma; direction: rtl; padding: 20px; }
button { padding: 6px 12px; margin: 10px 0; }
table { border-collapse: collapse; width: 100%; margin-top: 20px; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
th { background: #f0f0f0; }
</style>
</head>
<body>

<h2>محاسبه پاداش بر اساس فایل اکسل</h2>

<label>سقف بودجه بهره‌وری:</label><br>
<input id="budget" type="number" placeholder="مثلاً 5000000000"><br><br>

<input type="file" id="fileInput" accept=".xlsx">
<br>
<button onclick="processFile()">محاسبه</button>
<button onclick="exportExcel()">دانلود خروجی اکسل</button>

<div id="tableContainer"></div>

<script>
let finalData = [];

function processFile() {
  const file = document.getElementById("fileInput").files[0];
  const budget = Number(document.getElementById("budget").value);

  if (!file) return alert("فایل اکسل را انتخاب کنید");
  if (!budget) return alert("سقف بودجه را وارد کنید");

  const reader = new FileReader();
  reader.onload = function(e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: "array" });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    let rows = XLSX.utils.sheet_to_json(sheet, { defval: 0 });

    // میانگین سمت + منطقه
    const avgMap = {};
    rows.forEach(r => {
      const key = r["منطقه"] + "|" + r["سمت عملیاتی"];
      if (r["بهره‌وری ماه قبل"] > 0) {
        avgMap[key] = avgMap[key] || { sum: 0, count: 0 };
        avgMap[key].sum += r["بهره‌وری ماه قبل"];
        avgMap[key].count++;
      }
    });

    let total = 0;

    rows.forEach(r => {
      let prevProd = r["بهره‌وری ماه قبل"];
      if (!prevProd) {
        const key = r["منطقه"] + "|" + r["سمت عملیاتی"];
        if (avgMap[key]) {
          prevProd = avgMap[key].sum / avgMap[key].count;
        }
      }

      const rate = prevProd / r["تعداد روز ماه قبل"];
      let base = rate * r["تعداد روز کاری ماه جاری"] * r["ضریب بهره‌وری"];

      // ضریب اضافه‌کاری
      let change = 0;
      if (r["اضافه‌کاری ماه قبل"] > 0) {
        change = (r["اضافه‌کاری ماه جاری"] - r["اضافه‌کاری ماه قبل"])
                  / r["اضافه‌کاری ماه قبل"];
      }

      let overtimeFactor = 1;
      if (change < -0.2) overtimeFactor = 0.9;
      else if (change > 0.2 && change <= 0.5) overtimeFactor = 1.1;
      else if (change > 0.5) overtimeFactor = 1.2;

      const final = base * overtimeFactor;
      r["پاداش نهایی"] = Math.round(final);
      total += final;
    });

    // کنترل بودجه
    if (total > budget) {
      const scale = budget / total;
      rows.forEach(r => {
        r["پاداش نهایی"] = Math.round(r["پاداش نهایی"] * scale);
      });
    }

    finalData = rows;
    renderTable(rows);
  };

  reader.readAsArrayBuffer(file);
}

function renderTable(data) {
  let html = "<table><tr>";
  Object.keys(data[0]).forEach(k => html += "<th>" + k + "</th>");
  html += "</tr>";

  data.forEach(r => {
    html += "<tr>";
    Object.values(r).forEach(v => html += "<td>" + v + "</td>");
    html += "</tr>";
  });

  html += "</table>";
  document.getElementById("tableContainer").innerHTML = html;
}

function exportExcel() {
  if (!finalData.length) return alert("ابتدا محاسبه انجام شود");
  const ws = XLSX.utils.json_to_sheet(finalData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "نتیجه");
  XLSX.writeFile(wb, "خروجی_پاداش.xlsx");
}
</script>

</body>
</html>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>


