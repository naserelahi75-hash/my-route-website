<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<title>naser.ir | Ø³Ø§Ù…Ø§Ù†Ù‡ Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://static.neshan.org/sdk/leaflet/1.9.4/leaflet.css" />
<script src="https://static.neshan.org/sdk/leaflet/1.9.4/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body{margin:0;font-family:tahoma;background:#0f172a;color:#e5e7eb}
#loginBox,#app{height:100vh;display:flex;align-items:center;justify-content:center}
.login-box{background:#020617;padding:30px;border-radius:12px;width:320px}
.login-box input,.login-box button{width:100%;padding:10px;margin-top:10px;border-radius:6px;border:none}
.login-box button{background:#2563eb;color:#fff}
header{height:56px;background:#020617;display:flex;align-items:center;padding:0 20px;font-weight:bold}
.container{display:flex;height:calc(100vh - 56px)}
.sidebar{width:420px;background:#020617;padding:12px;overflow:auto}
.sidebar h3{margin:10px 0}
.sidebar input,.sidebar button{width:100%;padding:8px;margin:6px 0;border-radius:6px;border:none}
.sidebar button{background:#2563eb;color:#fff}
.list{max-height:260px;overflow:auto;border:1px solid #1f2933}
.item{padding:6px;border-bottom:1px solid #1f2933}
#map{flex:1}
table{width:100%;border-collapse:collapse;background:#fff;color:#000}
th,td{border:1px solid #ddd;padding:6px;text-align:center}
th{background:#f1f5f9}
.results{padding:10px;background:#e5e7eb}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginBox">
  <div class="login-box">
    <h3 style="text-align:center">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ naser.ir</h3>
    <input id="loginUser" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ">
    <input id="loginPass" type="password" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
    <button onclick="doLogin()">ÙˆØ±ÙˆØ¯</button>
  </div>
</div>

<!-- APP -->
<div id="app" style="display:none;flex-direction:column;width:100%">
<header>ğŸšš naser.ir | Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ ÙˆØ§Ù‚Ø¹ÛŒ Ú©Ø§Ù…ÛŒÙˆÙ†</header>
<div class="container">
<aside class="sidebar">
<h3>ğŸ“ ÙØ§ÛŒÙ„ ÙØ±ÙˆØ´Ú¯Ø§Ù‡â€ŒÙ‡Ø§ (Ø«Ø§Ø¨Øª Ø³ÛŒØ³ØªÙ…)</h3>
<input type="file" accept=".xlsx" onchange="loadExcel(this)">

<h3>ğŸ“ Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ù†Ø¨Ø§Ø±</h3>
<input id="warehouseSearch" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¢Ø¯Ø±Ø³ Ø§Ù†Ø¨Ø§Ø±">
<button onclick="searchWarehouse()">Ø«Ø¨Øª Ø§Ù†Ø¨Ø§Ø±</button>

<h3>ğŸª ÙÛŒÙ„ØªØ± ÙØ±ÙˆØ´Ú¯Ø§Ù‡â€ŒÙ‡Ø§</h3>
<input id="fCode" placeholder="Ú©Ø¯ ÙØ±ÙˆØ´Ú¯Ø§Ù‡" oninput="renderStores()">
<input id="fCity" placeholder="Ø´Ù‡Ø±" oninput="renderStores()">
<input id="fManager" placeholder="Ù…Ø³Ø¦ÙˆÙ„ Ù…Ù†Ø·Ù‚Ù‡" oninput="renderStores()">

<h3>ğŸ“‹ ÙØ±ÙˆØ´Ú¯Ø§Ù‡â€ŒÙ‡Ø§</h3>
<div class="list" id="storeList"></div>
<button onclick="calculateRoutes()">Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø³ÛŒØ±</button>
</aside>
<div id="map"></div>
</div>
<div class="results">
<table id="result">
<tr><th>Ú©Ø¯</th><th>Ø´Ù‡Ø±</th><th>Ù…Ø³Ø¦ÙˆÙ„</th><th>Ø±ÙØª Ùˆ Ø¨Ø±Ú¯Ø´Øª (km)</th></tr>
</table>
</div>
</div>

<script>
/* ===== ØªÙ†Ø¸ÛŒÙ…Ø§Øª ===== */
const LOGIN_CONFIG={user:"naser",pass:"12345"};
const API_KEY="service.2b2bc79d99084f40be64ee8e482a45ef";
let STORES=[];
let map,warehouseMarker,warehouse;

function doLogin(){
 const u=loginUser.value.trim();
 const p=loginPass.value.trim();
 if(u===LOGIN_CONFIG.user && p===LOGIN_CONFIG.pass){
  loginBox.style.display='none';
  app.style.display='flex';
  initMap();
 } else alert('Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª');
}

function initMap(){
 map=L.map('map',{key:API_KEY,center:[35.7,51.4],zoom:8});
 map.on('click',e=>{
  if(warehouseMarker) map.removeLayer(warehouseMarker);
  warehouse={lat:e.latlng.lat,lng:e.latlng.lng};
  warehouseMarker=L.marker(e.latlng).addTo(map).bindPopup('Ø§Ù†Ø¨Ø§Ø±').openPopup();
 });
}

async function searchWarehouse(){
 const r=await fetch(`https://api.neshan.org/v1/search?term=${warehouseSearch.value}&lat=35.7&lng=51.4`,{headers:{'Api-Key':API_KEY}});
 const d=await r.json();
 if(!d.items.length)return alert('ÛŒØ§ÙØª Ù†Ø´Ø¯');
 const loc=d.items[0].location;
 if(warehouseMarker) map.removeLayer(warehouseMarker);
 warehouse={lat:loc.y,lng:loc.x};
 warehouseMarker=L.marker([loc.y,loc.x]).addTo(map).bindPopup('Ø§Ù†Ø¨Ø§Ø±').openPopup();
 map.setView([loc.y,loc.x],13);
}

function loadExcel(input){
 const reader=new FileReader();
 reader.onload=e=>{
  const wb=XLSX.read(e.target.result,{type:'binary'});
  const ws=wb.Sheets[wb.SheetNames[0]];
  const data=XLSX.utils.sheet_to_json(ws);
  STORES=data.map(r=>({
   code:r.code||r['Ú©Ø¯'],
   city:r.city||r['Ø´Ù‡Ø±'],
   manager:r.manager||r['Ù…Ø³Ø¦ÙˆÙ„'],
   lat:parseFloat(r.lat||r['lat']),
   lng:parseFloat(r.lng||r['lng'])
  }));
  renderStores();
 };
 reader.readAsBinaryString(input.files[0]);
}

function renderStores(){
 storeList.innerHTML='';
 STORES.filter(s=>(!fCode.value||s.code==fCode.value)&&(!fCity.value||s.city?.includes(fCity.value))&&(!fManager.value||s.manager?.includes(fManager.value)))
 .forEach(s=>{
  storeList.innerHTML+=`<div class="item"><label><input type="checkbox" value="${s.code}"> ${s.code} - ${s.city} - ${s.manager}</label></div>`;
 });
}

async function calculateRoutes(){
 if(!warehouse)return alert('Ø§Ù†Ø¨Ø§Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡');
 result.innerHTML='<tr><th>Ú©Ø¯</th><th>Ø´Ù‡Ø±</th><th>Ù…Ø³Ø¦ÙˆÙ„</th><th>Ø±ÙØª Ùˆ Ø¨Ø±Ú¯Ø´Øª (km)</th></tr>';
 const selected=[...document.querySelectorAll('input[type=checkbox]:checked')].map(c=>STORES.find(s=>s.code==c.value));
 for(let s of selected){
  const r=await fetch(`https://api.neshan.org/v4/direction?type=truck&origin=${warehouse.lat},${warehouse.lng}&destination=${s.lat},${s.lng}`,{headers:{'Api-Key':API_KEY}});
  const d=await r.json();
  const km=(d.routes[0].legs[0].distance.value*2/1000).toFixed(1);
  result.innerHTML+=`<tr><td>${s.code}</td><td>${s.city}</td><td>${s.manager}</td><td>${km}</td></tr>`;
 }
}
</script>
</body>
</html>
