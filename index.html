<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <title>Ø³Ø§Ù…Ø§Ù†Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø³ÛŒØ± Ø­Ù…Ù„â€ŒÙˆÙ†Ù‚Ù„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body {
      margin: 0;
      font-family: Tahoma, sans-serif;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color: #fff;
    }

    header {
      text-align: center;
      padding: 20px;
      font-size: 22px;
      font-weight: bold;
    }

    .container {
      display: grid;
      grid-template-columns: 360px 1fr;
      height: calc(100vh - 80px);
      gap: 15px;
      padding: 15px;
    }

    .panel {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 15px;
    }

    .panel h3 {
      margin-top: 0;
      font-size: 16px;
      border-bottom: 1px solid rgba(255,255,255,0.3);
      padding-bottom: 8px;
    }

    label {
      font-size: 13px;
      opacity: 0.9;
    }

    input, select {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: none;
      font-size: 14px;
      margin-bottom: 10px;
    }

    button {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: none;
      background: linear-gradient(to right, #0072ff, #00c6ff);
      color: #fff;
      font-size: 15px;
      cursor: pointer;
    }

    #result {
      margin-top: 12px;
      font-size: 14px;
      line-height: 1.9;
    }

    #map {
      border-radius: 12px;
    }
  </style>
</head>
<body>

<header>ğŸšš Ø³Ø§Ù…Ø§Ù†Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø³ÛŒØ± Ùˆ Ù…Ø³Ø§ÙØª Ø­Ù…Ù„â€ŒÙˆÙ†Ù‚Ù„</header>

<div class="container">

  <div class="panel">
    <h3>Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø³ÛŒØ±</h3>

    <label>Ù…Ø®ØªØµØ§Øª Ù…Ø¨Ø¯Ø§ (lat,lng)</label>
    <input id="origin" placeholder="35.750262,51.479961" />

    <label>Ù…Ø®ØªØµØ§Øª Ù…Ù‚ØµØ¯ (lat,lng)</label>
    <input id="destination" placeholder="35.670586,51.296191" />

    <label>Ù†ÙˆØ¹ Ù†Ø§ÙˆÚ¯Ø§Ù†</label>
    <select id="vehicle">
      <option value="car">ğŸš— Ø³ÙˆØ§Ø±ÛŒ</option>
      <option value="truck">ğŸšš Ú©Ø§Ù…ÛŒÙˆÙ†</option>
    </select>

    <button onclick="calculateRoute()">Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø³ÛŒØ±</button>

    <div id="result"></div>
    <table id="resultsTable" style="width:100%;margin-top:12px;border-collapse:collapse;font-size:13px;display:none">
      <thead>
        <tr style="background:rgba(255,255,255,0.15)">
          <th>Ù…Ø³ÛŒØ±</th>
          <th>Ú©ÛŒÙ„ÙˆÙ…ØªØ±</th>
          <th>Ø±ÙØªâ€ŒÙˆØ¨Ø±Ú¯Ø´Øª</th>
          <th>Ø²Ù…Ø§Ù† (Ø³Ø§Ø¹Øª)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <p style="font-size:12px;opacity:0.8;margin-top:10px">
      ğŸ’¡ Ú©Ù„ÛŒÚ© Ø§ÙˆÙ„ Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡ = Ù…Ø¨Ø¯Ø§ | Ú©Ù„ÛŒÚ© Ø¯ÙˆÙ… = Ù…Ù‚ØµØ¯
    </p>
  </div>

  <div id="map"></div>
</div>

<script>
  const map = L.map('map').setView([32.4279, 53.688], 5);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap'
  }).addTo(map);

  let markers = [];
  let routeLine;

  map.on('click', function (e) {
    if (markers.length === 2) {
      markers.forEach(m => map.removeLayer(m));
      markers = [];
      if (routeLine) map.removeLayer(routeLine);
    }

    const marker = L.marker(e.latlng).addTo(map);
    markers.push(marker);

    const coord = `${e.latlng.lat.toFixed(6)},${e.latlng.lng.toFixed(6)}`;

    if (markers.length === 1) origin.value = coord;
    if (markers.length === 2) destination.value = coord;
  });

  async function calculateRoute() {
    const [olat, olng] = origin.value.split(',').map(Number);
    const [dlat, dlng] = destination.value.split(',').map(Number);

    if (!olat || !olng || !dlat || !dlng) {
      alert('Ù…Ø®ØªØµØ§Øª Ø±Ø§ ØµØ­ÛŒØ­ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
      return;
    }

    const vehicle = document.getElementById('vehicle').value;
    const speed = vehicle === 'truck' ? 70 : 90;

    const routes = [];

    async function fetchRoute(points) {
      const coords = points.map(p => `${p.lng},${p.lat}`).join(';');
      const url = `https://router.project-osrm.org/route/v1/driving/${coords}?overview=full&geometries=geojson`;
      const res = await fetch(url);
      const data = await res.json();
      return data.routes[0];
    }

    // Ù…Ø³ÛŒØ± Ø§ØµÙ„ÛŒ
    routes.push(await fetchRoute([
      { lat: olat, lng: olng },
      { lat: dlat, lng: dlng }
    ]));

    // Ù…Ø³ÛŒØ± Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† 1 (Ø§Ù†Ø­Ø±Ø§Ù Ø´Ù…Ø§Ù„ÛŒ)
    routes.push(await fetchRoute([
      { lat: olat, lng: olng },
      { lat: olat + 0.3, lng: olng },
      { lat: dlat, lng: dlng }
    ]));

    // Ù…Ø³ÛŒØ± Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† 2 (Ø§Ù†Ø­Ø±Ø§Ù Ø¬Ù†ÙˆØ¨ÛŒ)
    routes.push(await fetchRoute([
      { lat: olat, lng: olng },
      { lat: olat - 0.3, lng: olng },
      { lat: dlat, lng: dlng }
    ]));

    if (routeLine) map.removeLayer(routeLine);

    let totalDistance = 0;

    routes.forEach((r, i) => {
      totalDistance += r.distance / 1000;
      L.geoJSON(r.geometry, {
        style: {
          color: i === 0 ? 'cyan' : i === 1 ? 'yellow' : 'orange',
          weight: 3,
          opacity: 0.8
        }
      }).addTo(map);
    });

    const avgDistance = totalDistance / 3;
    const table = document.getElementById('resultsTable');
    const tbody = table.querySelector('tbody');
    tbody.innerHTML = '';

    routes.forEach((r, i) => {
      const km = r.distance / 1000;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>Ù…Ø³ÛŒØ± ${i + 1}</td>
        <td>${km.toFixed(2)}</td>
        <td>${(km * 2).toFixed(2)}</td>
        <td>${(km / speed).toFixed(2)}</td>
      `;
      tbody.appendChild(tr);
    });

    const avgRow = document.createElement('tr');
    avgRow.style.background = 'rgba(0,198,255,0.2)';
    avgRow.innerHTML = `
      <td><b>Ù…ÛŒØ§Ù†Ú¯ÛŒÙ†</b></td>
      <td><b>${avgDistance.toFixed(2)}</b></td>
      <td><b>${(avgDistance * 2).toFixed(2)}</b></td>
      <td><b>${avgTime.toFixed(2)}</b></td>
    `;
    tbody.appendChild(avgRow);

    table.style.display = 'table';
    const avgRoundTrip = avgDistance * 2;
    const avgTime = avgDistance / speed;

    result.innerHTML = `
      ğŸ›£ï¸ Ù…Ø³ÛŒØ± Û±: ${(routes[0].distance / 1000).toFixed(2)} km<br>
      ğŸ›£ï¸ Ù…Ø³ÛŒØ± Û²: ${(routes[1].distance / 1000).toFixed(2)} km<br>
      ğŸ›£ï¸ Ù…Ø³ÛŒØ± Û³: ${(routes[2].distance / 1000).toFixed(2)} km<br><hr>
      ğŸ“Š Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ù…Ø³ÛŒØ±: <b>${avgDistance.toFixed(2)} km</b><br>
      ğŸ” Ø±ÙØª Ùˆ Ø¨Ø±Ú¯Ø´Øª Ù…ÛŒØ§Ù†Ú¯ÛŒÙ†: <b>${avgRoundTrip.toFixed(2)} km</b><br>
      â± Ø²Ù…Ø§Ù† ØªØ®Ù…ÛŒÙ†ÛŒ (${vehicle === 'truck' ? 'Ú©Ø§Ù…ÛŒÙˆÙ†' : 'Ø³ÙˆØ§Ø±ÛŒ'}): <b>${avgTime.toFixed(2)} Ø³Ø§Ø¹Øª</b>
    `;

    map.fitBounds(L.geoJSON(routes[0].geometry).getBounds());
  }() {
    const [olat, olng] = origin.value.split(',').map(Number);
    const [dlat, dlng] = destination.value.split(',').map(Number);

    if (!olat || !olng || !dlat || !dlng) {
      alert('Ù…Ø®ØªØµØ§Øª Ø±Ø§ ØµØ­ÛŒØ­ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
      return;
    }

    const url = `https://router.project-osrm.org/route/v1/driving/${olng},${olat};${dlng},${dlat}?overview=full&geometries=geojson`;

    const res = await fetch(url);
    const data = await res.json();

    const route = data.routes[0];
    const distanceKm = route.distance / 1000;
    const baseDurationHr = route.duration / 3600;

    const vehicle = document.getElementById('vehicle').value;
    const speed = vehicle === 'truck' ? 70 : 90;

    const adjustedTime = distanceKm / speed;

    if (routeLine) map.removeLayer(routeLine);

    routeLine = L.geoJSON(route.geometry, {
      style: { color: 'cyan', weight: 4 }
    }).addTo(map);

    map.fitBounds(routeLine.getBounds());

    result.innerHTML = `
      ğŸ“ ÙØ§ØµÙ„Ù‡ Ù…Ø³ÛŒØ±: <b>${distanceKm.toFixed(2)} km</b><br>
      ğŸ” Ø±ÙØª Ùˆ Ø¨Ø±Ú¯Ø´Øª: <b>${(distanceKm * 2).toFixed(2)} km</b><br>
      â± Ø²Ù…Ø§Ù† ØªØ®Ù…ÛŒÙ†ÛŒ (${vehicle === 'truck' ? 'Ú©Ø§Ù…ÛŒÙˆÙ†' : 'Ø³ÙˆØ§Ø±ÛŒ'}): <b>${adjustedTime.toFixed(2)} Ø³Ø§Ø¹Øª</b>
    `;
  }
</script>

</body>
</html>
