<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>naser.ir | Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ ÙˆØ§Ù‚Ø¹ÛŒ Ú©Ø§Ù…ÛŒÙˆÙ†</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body{
  margin:0;
  font-family:tahoma;
  background:#0b1220;
  color:#fff;
}

/* LOGIN */
#loginBox{
  width:320px;
  margin:150px auto;
  background:#111827;
  padding:20px;
  border-radius:8px;
  text-align:center;
}
#loginBox input,#loginBox button{
  width:100%;
  padding:10px;
  margin:6px 0;
}

/* APP */
#app{
  display:none;
  height:100vh;
}
#sidebar{
  width:380px;
  background:#111827;
  padding:10px;
  overflow:auto;
}
#map{
  flex:1;
}

input,button{
  border-radius:4px;
  border:none;
}
button{
  background:#2563eb;
  color:#fff;
  cursor:pointer;
}

table{
  width:100%;
  margin-top:10px;
  border-collapse:collapse;
  font-size:13px;
}
th,td{
  border:1px solid #333;
  padding:4px;
  text-align:center;
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginBox">
  <h3>ÙˆØ±ÙˆØ¯ Ø¨Ù‡ naser.ir</h3>
  <input id="user" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ">
  <input id="pass" type="password" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
  <button onclick="login()">ÙˆØ±ÙˆØ¯</button>
</div>

<!-- APP -->
<div id="app">
  <div id="sidebar">
    <h4>ğŸ“ Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ù†Ø¨Ø§Ø± (Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡)</h4>
    <input id="warehouse" placeholder="lat,lng Ø§Ù†Ø¨Ø§Ø±" readonly>

    <h4>ğŸ” Ø¬Ø³ØªØ¬ÙˆÛŒ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ (Ú©Ø¯ Ø§Ù„Ø²Ø§Ù…ÛŒ)</h4>
    <input id="search" placeholder="Ú©Ø¯ ÙØ±ÙˆØ´Ú¯Ø§Ù‡" oninput="renderStores()">

    <div id="storeList" style="max-height:220px;overflow:auto"></div>

    <button onclick="calculate()">ğŸšš Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø³ÛŒØ± Ú©Ø§Ù…ÛŒÙˆÙ†</button>

    <table>
      <thead>
        <tr>
          <th>Ú©Ø¯</th>
          <th>Ø´Ù‡Ø±</th>
          <th>Ù…Ø³Ø¦ÙˆÙ„</th>
          <th>Ø±ÙØªâ€ŒÙˆØ¨Ø±Ú¯Ø´Øª km</th>
        </tr>
      </thead>
      <tbody id="result"></tbody>
    </table>
  </div>

  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
/* ========= ØªÙ†Ø¸ÛŒÙ…Ø§Øª ========= */
const USER="naser";
const PASS="12345";
const NESHAN_KEY="service.2b2bc79d99084f40be64ee8e482a45ef";

/* ========= Ø¯Ø§Ø¯Ù‡ Ø«Ø§Ø¨Øª ÙØ±ÙˆØ´Ú¯Ø§Ù‡â€ŒÙ‡Ø§ ========= */
const stores=[
 {code:"1008",city:"ØªÙ‡Ø±Ø§Ù†",manager:"Ø§Ø­Ù…Ø¯ÛŒ",lat:35.6892,lng:51.3890},
 {code:"1010",city:"Ú©Ø±Ø¬",manager:"Ø±Ø¶Ø§ÛŒÛŒ",lat:35.8400,lng:50.9391},
 {code:"1020",city:"Ù‚Ù…",manager:"Ù…Ø­Ù…Ø¯ÛŒ",lat:34.6416,lng:50.8746}
];

/* ========= Ù…ØªØºÛŒØ±Ù‡Ø§ ========= */
let map,warehouseMarker,warehouse;

/* ========= Ù„Ø§Ú¯ÛŒÙ† ========= */
function login(){
 if(user.value===USER && pass.value===PASS){
   loginBox.style.display="none";
   app.style.display="flex";
   initMap();
   renderStores();
 }else{
   alert("ÛŒÙˆØ²Ø± ÛŒØ§ Ù¾Ø³ÙˆØ±Ø¯ Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª");
 }
}
document.addEventListener("keydown",e=>{
 if(e.key==="Enter") login();
});

/* ========= Ù†Ù‚Ø´Ù‡ ========= */
function initMap(){
 map=L.map("map").setView([35.7,51.4],10);
 L.tileLayer(
  "https://api.neshan.org/v4/map/standard/{z}/{x}/{y}.png",
  {
   maxZoom:19,
   attribution:"Â© Neshan",
   headers:{"Api-Key":NESHAN_KEY}
  }
 ).addTo(map);

 map.on("click",e=>{
  warehouse=e.latlng;
  if(warehouseMarker) map.removeLayer(warehouseMarker);
  warehouseMarker=L.marker(e.latlng).addTo(map).bindPopup("Ø§Ù†Ø¨Ø§Ø±").openPopup();
  warehouseInput();
 });
}
function warehouseInput(){
 warehouseInputEl=document.getElementById("warehouse");
 warehouseInputEl.value=warehouse.lat+","+warehouse.lng;
}

/* ========= ÙØ±ÙˆØ´Ú¯Ø§Ù‡â€ŒÙ‡Ø§ ========= */
function renderStores(){
 storeList.innerHTML="";
 const q=search.value;
 stores.filter(s=>!q || s.code.includes(q)).forEach(s=>{
  storeList.innerHTML+=`
   <div>
    <input type="checkbox" value="${s.code}">
    ${s.code} - ${s.city||""} - ${s.manager||""}
   </div>`;
 });
}

/* ========= Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø³ÛŒØ± ========= */
function calculate(){
 if(!warehouse){alert("Ø§Ù†Ø¨Ø§Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡");return;}
 result.innerHTML="";
 const selected=[...document.querySelectorAll("input[type=checkbox]:checked")]
  .map(c=>stores.find(s=>s.code===c.value));

 selected.forEach(s=>routeDistance(s));
}

function routeDistance(s){
 const url=`https://api.neshan.org/v4/direction?origin=${warehouse.lat},${warehouse.lng}&destination=${s.lat},${s.lng}&vehicle=truck`;
 fetch(url,{headers:{"Api-Key":NESHAN_KEY}})
  .then(r=>r.json())
  .then(d=>{
   const km=(d.routes[0].legs[0].distance.value/1000)*2;
   result.innerHTML+=`
    <tr>
     <td>${s.code}</td>
     <td>${s.city||"-"}</td>
     <td>${s.manager||"-"}</td>
     <td>${km.toFixed(1)}</td>
    </tr>`;
  });
}
</script>
</body>
</html>
