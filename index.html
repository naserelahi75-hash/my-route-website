<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ú©Ø§Ù…ÛŒÙˆÙ†</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body {margin:0;font-family:tahoma}
#map {height:100vh;width:70%}
#panel {
width:30%;height:100vh;position:absolute;right:0;top:0;
background:#111;color:#fff;padding:10px;overflow:auto
}
input,button {width:100%;padding:6px;margin:5px 0}
table {width:100%;font-size:12px;margin-top:10px}
td,th {border:1px solid #555;padding:4px}
</style>
</head>

<body>

<div id="map"></div>

<div id="panel">
<h3>ğŸ“¦ ÙØ±ÙˆØ´Ú¯Ø§Ù‡â€ŒÙ‡Ø§</h3>
<input type="file" id="file">
<input id="search" placeholder="Ø¬Ø³ØªØ¬Ùˆ">
<button onclick="route()">Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø³ÛŒØ± Ú©Ø§Ù…ÛŒÙˆÙ†</button>

<table id="result">
<tr><th>Ú©Ø¯</th><th>Ù…Ø³Ø§ÙØª (km)</th></tr>
</table>
</div>

<script>
const NESHAN_KEY = "service.2b2bc79d99084f40be64ee8e482a45ef";

// Ù†Ù‚Ø´Ù‡ Ù†Ø´Ø§Ù†
const map = L.map('map').setView([35.7,51.4], 10);
L.tileLayer('https://api.neshan.org/v2/staticmap?', {
}).addTo(map);

// Ù„Ø§ÛŒÙ‡ OSM Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† (Ù¾Ø§ÛŒØ¯Ø§Ø±)
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let warehouse = null;
let shops = [];
let markers = [];
let lines = [];

// Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ù†Ø¨Ø§Ø±
map.on('click', e => {
 if (warehouse) map.removeLayer(warehouse);
 warehouse = L.marker(e.latlng, {draggable:true})
 .addTo(map).bindPopup('Ø§Ù†Ø¨Ø§Ø±').openPopup();
});

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ú©Ø³Ù„
file.onchange = e => {
 const reader = new FileReader();
 reader.onload = ev => {
  const wb = XLSX.read(ev.target.result, {type:'binary'});
  shops = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
  draw();
 };
 reader.readAsBinaryString(e.target.files[0]);
};

// Ø³Ø±Ú†
search.oninput = draw;

function draw(){
 markers.forEach(m=>map.removeLayer(m));
 markers=[];
 shops.filter(s=>JSON.stringify(s).includes(search.value))
 .forEach(s=>{
  const [lat,lng] = s.latlng.split(',').map(Number);
  const m = L.marker([lat,lng]).addTo(map)
  .bindPopup(`Ú©Ø¯ ÙØ±ÙˆØ´Ú¯Ø§Ù‡: ${s["Ú©Ø¯ ÙØ±ÙˆØ´Ú¯Ø§Ù‡"]}`);
  m.shop = s;
  markers.push(m);
 });
}

// Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø³ÛŒØ± Ú©Ø§Ù…ÛŒÙˆÙ†
async function route(){
 if(!warehouse) return alert("Ø§Ù†Ø¨Ø§Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡");

 result.innerHTML = '<tr><th>Ú©Ø¯</th><th>km</th></tr>';
 lines.forEach(l=>map.removeLayer(l));
 lines=[];

 for (const m of markers){
  const res = await fetch(
   `https://api.neshan.org/v4/direction?type=truck&origin=`+
   `${warehouse.getLatLng().lat},${warehouse.getLatLng().lng}`+
   `&destination=${m.getLatLng().lat},${m.getLatLng().lng}`,
   {headers:{'Api-Key':NESHAN_KEY}}
  );
  const data = await res.json();
  const km = data.routes[0].legs[0].distance.value/1000*2;

  result.innerHTML += `<tr><td>${m.shop["Ú©Ø¯ ÙØ±ÙˆØ´Ú¯Ø§Ù‡"]}</td><td>${km.toFixed(1)}</td></tr>`;

  lines.push(L.polyline(
   data.routes[0].overview_polyline.points
  ).addTo(map));
 }
}
</script>

</body>
</html>
