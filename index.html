function toNumber(v) {
    if (v === undefined || v === null || v === "") return 0;
    return Number(String(v).replace(/,/g, "")) || 0;
}

function calculateProductivity(rows) {

    // ===== محاسبه میانگین برای پرسنل جدید =====
    const avgMap = {};

    rows.forEach(r => {
        const region = r["منطقه"];
        const role = r["سمت عملیاتی"];
        const prevProd = toNumber(r["بهروری ماه قبل"]);
        const prevDays = toNumber(r["نردد ماه قبل"]);

        if (prevProd > 0 && prevDays > 0) {
            const key = region + "|" + role;
            if (!avgMap[key]) avgMap[key] = { sum: 0, count: 0 };
            avgMap[key].sum += prevProd;
            avgMap[key].count++;
        }
    });

    rows.forEach(r => {
        const region = r["منطقه"];
        const role = r["سمت عملیاتی"];

        let prevProd = toNumber(r["بهروری ماه قبل"]);
        let prevDays = toNumber(r["نردد ماه قبل"]);
        const currentDays = toNumber(r["تعداد روز کاری ماه جاری"]);
        const factor = toNumber(r["ضریب بهره وری"]) || 1;

        const otPrev = toNumber(r["اضافه کاری ماه قبل"]);
        const otCurrent = toNumber(r["اضافه کاری ماه جاری"]);

        // ===== پرسنل جدید =====
        if (prevProd === 0 || prevDays === 0) {
            const key = region + "|" + role;
            if (avgMap[key] && avgMap[key].count > 0) {
                prevProd = avgMap[key].sum / avgMap[key].count;
                prevDays = currentDays || 30;
            }
        }

        // ===== محاسبه =====
        let daily = prevDays > 0 ? prevProd / prevDays : 0;
        let base = daily * currentDays;
        let afterFactor = base * factor;

        let otChange = otCurrent - otPrev;
        let otEffect = 1 + (otChange * 0.03);

        let finalValue = afterFactor * otEffect;

        // بدون اعشار
        r["محاسبه بهروری ماه جدید"] = Math.round(finalValue);
    });

    return rows;
}
