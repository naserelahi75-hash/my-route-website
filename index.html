<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø³Ø§Ù…Ø§Ù†Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø³ÛŒØ± Ùˆ Ù…Ø³Ø§ÙØª Ø­Ù…Ù„â€ŒÙˆÙ†Ù‚Ù„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Neshan Map -->
  <link href="https://static.neshan.org/sdk/leaflet/1.4.0/leaflet.css" rel="stylesheet" />
  <script src="https://static.neshan.org/sdk/leaflet/1.4.0/leaflet.js"></script>

  <style>
    body {
      margin: 0;
      font-family: Tahoma, sans-serif;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color: #fff;
    }
    header {
      text-align: center;
      padding: 15px;
      font-size: 20px;
      font-weight: bold;
    }
    .container {
      display: grid;
      grid-template-columns: 340px 1fr;
      height: calc(100vh - 60px);
    }
    .panel {
      background: rgba(0,0,0,0.4);
      padding: 15px;
    }
    label { font-size: 13px; }
    input, select, button {
      width: 100%;
      margin-top: 6px;
      margin-bottom: 10px;
      padding: 8px;
      border-radius: 6px;
      border: none;
      font-size: 14px;
    }
    button {
      background: linear-gradient(to right, #0072ff, #00c6ff);
      color: #fff;
      cursor: pointer;
    }
    #map { height: 100%; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 13px;
    }
    th, td {
      border: 1px solid rgba(255,255,255,0.3);
      padding: 6px;
      text-align: center;
    }
    th { background: rgba(0,0,0,0.4); }
  </style>
</head>
<body>

<header>ğŸšš Ø³Ø§Ù…Ø§Ù†Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø³ÛŒØ± Ùˆ Ù…Ø³Ø§ÙØª Ø­Ù…Ù„â€ŒÙˆÙ†Ù‚Ù„</header>

<div class="container">
  <div class="panel">
    <label>Ù…Ø®ØªØµØ§Øª Ù…Ø¨Ø¯Ø§ (lat,lng)</label>
    <input id="start" placeholder="Ù…Ø«Ø§Ù„: 35.6892,51.3890" />

    <label>Ù…Ø®ØªØµØ§Øª Ù…Ù‚ØµØ¯ (lat,lng)</label>
    <input id="end" placeholder="Ù…Ø«Ø§Ù„: 35.6280,51.3912" />

    <label>Ù†ÙˆØ¹ Ù†Ø§ÙˆÚ¯Ø§Ù†</label>
    <select id="vehicle">
      <option value="car">ğŸš— Ø³ÙˆØ§Ø±ÛŒ</option>
      <option value="truck">ğŸš› Ú©Ø§Ù…ÛŒÙˆÙ†</option>
    </select>

    <button onclick="calculateRoute()">Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø³ÛŒØ±</button>

    <div id="results"></div>
    <p style="font-size:12px;opacity:.8">Ú©Ù„ÛŒÚ© Ø§ÙˆÙ„ Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡ = Ù…Ø¨Ø¯Ø§ | Ú©Ù„ÛŒÚ© Ø¯ÙˆÙ… = Ù…Ù‚ØµØ¯</p>
  </div>

  <div id="map"></div>
</div>

<script>
  const API_KEY = "service.2b2bc79d99084f40be64ee8e482a45ef"; // â† Ú©Ù„ÛŒØ¯ Ù†Ø´Ø§Ù†

  const map = L.map('map').setView([35.6892, 51.3890], 10);
  L.tileLayer('https://tile.neshan.org/style/neshan/{z}/{x}/{y}.png', {
    attribution: 'Â© Neshan'
  }).addTo(map);

  let markers = [];
  let clickCount = 0;

  map.on('click', e => {
    if (markers.length === 2) {
      markers.forEach(m => map.removeLayer(m));
      markers = [];
    }
    const m = L.marker(e.latlng).addTo(map);
    markers.push(m);

    const coord = `${e.latlng.lat},${e.latlng.lng}`;
    if (clickCount === 0) {
      start.value = coord;
      clickCount = 1;
    } else {
      end.value = coord;
      clickCount = 0;
    }
  });

  async function calculateRoute() {
    const s = start.value.trim();
    const e = end.value.trim();
    const vehicle = vehicleSelect = document.getElementById('vehicle').value;

    if (!s || !e) {
      alert('Ù…Ø¨Ø¯Ø§ Ùˆ Ù…Ù‚ØµØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ ÛŒØ§ Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†');
      return;
    }

    const [sLat, sLng] = s.split(',');
    const [eLat, eLng] = e.split(',');

    const url = `https://api.neshan.org/v4/direction?origin=${sLat},${sLng}&destination=${eLat},${eLng}&vehicle=${vehicle}&alternatives=true`;

    const res = await fetch(url, {
      headers: { 'Api-Key': API_KEY }
    });

    const data = await res.json();
    renderResults(data.routes);
  }

  function renderResults(routes) {
    let sum = 0;
    let html = `<table><tr><th>Ù…Ø³ÛŒØ±</th><th>ÙØ§ØµÙ„Ù‡ (km)</th></tr>`;

    routes.forEach((r, i) => {
      const km = (r.distance / 1000).toFixed(2);
      sum += Number(km);
      html += `<tr><td>${i+1}</td><td>${km}</td></tr>`;
    });

    const avg = (sum / routes.length).toFixed(2);
    html += `<tr><th>Ù…ÛŒØ§Ù†Ú¯ÛŒÙ†</th><th>${avg}</th></tr>`;
    html += `<tr><th>Ø±ÙØª Ùˆ Ø¨Ø±Ú¯Ø´Øª</th><th>${(avg*2).toFixed(2)}</th></tr>`;
    html += `</table>`;

    document.getElementById('results').innerHTML = html;
  }
</script>

</body>
</html>
