<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>naser.ir | Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ Ú©Ø§Ù…ÛŒÙˆÙ†</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body{margin:0;height:100%;font-family:tahoma}
#login,#app{height:100%;display:none}
#login{display:flex;align-items:center;justify-content:center;background:#0f172a}
#loginBox{background:#020617;padding:30px;width:300px;border-radius:10px;color:#fff}
input,button{width:100%;padding:10px;margin-top:10px;border-radius:5px;border:none}
button{background:#2563eb;color:#fff;cursor:pointer}

#app{display:flex}
#sidebar{width:320px;background:#020617;color:#fff;padding:12px}
#map{flex:1}

.store{padding:8px;border-bottom:1px solid #333;cursor:pointer}
.store:hover{background:#1e293b}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login">
 <div id="loginBox">
  <h3>naser.ir</h3>
  <input id="u" placeholder="user">
  <input id="p" type="password" placeholder="password">
  <button onclick="doLogin()">ÙˆØ±ÙˆØ¯</button>
 </div>
</div>

<!-- APP -->
<div id="app">
 <div id="sidebar">
  <h4>ğŸ“ Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ù†Ø¨Ø§Ø±</h4>
  <div id="wh">Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡ Ú©Ù„ÛŒÚ© Ú©Ù†</div>

  <hr>

  <h4>ğŸ” Ø¬Ø³ØªØ¬ÙˆÛŒ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ (Ú©Ø¯)</h4>
  <input id="search">

  <div id="list"></div>
 </div>

 <div id="map"></div>
</div>

<script>
/* ================== ØªÙ†Ø¸ÛŒÙ…Ø§Øª ================== */
const NESHAN_KEY = "YOUR_NESHAN_API_KEY";

/* ÛŒÙˆØ²Ø± Ù¾Ø³ÙˆØ±Ø¯ */
const USER="naser", PASS="12345";

/* Ø¯Ø§Ø¯Ù‡ ÙØ±ÙˆØ´Ú¯Ø§Ù‡â€ŒÙ‡Ø§ (Ø«Ø§Ø¨Øª â€“ ÛŒÚ©â€ŒØ¬Ø§) */
const STORES=[
 {code:"1008",city:"ØªÙ‡Ø±Ø§Ù†",manager:"Ø§Ø­Ù…Ø¯ÛŒ",lat:35.72,lng:51.42},
 {code:"1010",city:"Ú©Ø±Ø¬",manager:"Ù…Ø­Ù…Ø¯ÛŒ",lat:35.83,lng:50.97},
 {code:"1020",city:"Ù‚Ù…",manager:"Ø±Ø¶Ø§ÛŒÛŒ",lat:34.64,lng:50.88}
];

/* ================== LOGIN ================== */
if(localStorage.getItem("login")==="ok"){
 showApp();
}else{
 login.style.display="flex";
}

function doLogin(){
 if(u.value===USER && p.value===PASS){
  localStorage.setItem("login","ok");
  showApp();
 }else alert("Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª");
}

document.addEventListener("keydown",e=>{
 if(e.key==="Enter" && login.style.display==="flex") doLogin();
});

function showApp(){
 login.style.display="none";
 app.style.display="flex";
 initMap();
}

/* ================== MAP ================== */
let map,warehouseMarker,warehouse,routeLine;

function initMap(){
 map=L.map("map").setView([35.7,51.4],7);

 L.tileLayer(
  "https://static.neshan.org/sdk/leaflet/v1/tiles/default/{z}/{x}/{y}.png",
  {maxZoom:18}
 ).addTo(map);

 map.on("click",e=>{
  warehouse=e.latlng;
  if(warehouseMarker) map.removeLayer(warehouseMarker);
  warehouseMarker=L.marker(e.latlng).addTo(map).bindPopup("Ø§Ù†Ø¨Ø§Ø±").openPopup();
  wh.innerText=`${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`;
 });

 renderStores();
 search.oninput=renderStores;
}

/* ================== STORES ================== */
function renderStores(){
 list.innerHTML="";
 const q=search.value.trim();
 STORES.filter(s=>!q || s.code.includes(q)).forEach(s=>{
  const d=document.createElement("div");
  d.className="store";
  d.innerText=`${s.code} | ${s.city} | ${s.manager}`;
  d.onclick=()=>selectStore(s);
  list.appendChild(d);
 });
}

function selectStore(s){
 if(!warehouse){alert("Ø§ÙˆÙ„ Ø§Ù†Ø¨Ø§Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†");return;}

 const m=L.marker([s.lat,s.lng]).addTo(map);
 map.setView([s.lat,s.lng],12);

 const url=`https://api.neshan.org/v4/direction?origin=${warehouse.lat},${warehouse.lng}&destination=${s.lat},${s.lng}&vehicle=truck`;

 fetch(url,{headers:{"Api-Key":NESHAN_KEY}})
 .then(r=>r.json())
 .then(d=>{
  const leg=d.routes[0].legs[0];
  const km=(leg.distance.value/1000)*2;

  m.bindPopup(`
   <b>Ú©Ø¯:</b> ${s.code}<br>
   <b>Ø´Ù‡Ø±:</b> ${s.city}<br>
   <b>Ù…Ø³Ø¦ÙˆÙ„:</b> ${s.manager}<br>
   <b>Ø±ÙØª Ùˆ Ø¨Ø±Ú¯Ø´Øª:</b> ${km.toFixed(1)} km<br>
   <b>Ù…Ø³ÛŒØ±:</b> Ú©ÙˆØªØ§Ù‡â€ŒØªØ±ÛŒÙ† Ù…Ø³ÛŒØ±
  `).openPopup();

  if(routeLine) map.removeLayer(routeLine);
  routeLine=L.polyline(
   leg.steps.flatMap(st=>st.polyline),
   {color:"blue",weight:5}
  ).addTo(map);
 });
}
</script>
</body>
</html>
