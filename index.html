<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>naser.ir | Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ Ú©Ø§Ù…ÛŒÙˆÙ†</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body{margin:0;font-family:tahoma;background:#0b1220;color:#fff}
#login,#app{height:100vh}
#login{
 display:flex;justify-content:center;align-items:center
}
#loginBox{
 width:320px;background:#111827;padding:20px;border-radius:8px
}
input,button{
 width:100%;padding:10px;margin:6px 0;border:none;border-radius:4px
}
button{background:#2563eb;color:#fff;cursor:pointer}
#app{display:none;flex-direction:row}
#side{
 width:360px;background:#111827;padding:10px;overflow:auto
}
#map{flex:1}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{border:1px solid #333;padding:4px;text-align:center}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login">
 <div id="loginBox">
  <h3>ÙˆØ±ÙˆØ¯ naser.ir</h3>
  <input id="u" placeholder="user">
  <input id="p" type="password" placeholder="password">
  <button onclick="doLogin()">ÙˆØ±ÙˆØ¯</button>
 </div>
</div>

<!-- APP -->
<div id="app">
 <div id="side">
  <h4>ğŸ“ Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ù†Ø¨Ø§Ø± (Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡)</h4>
  <input id="wh" readonly>

  <h4>ğŸ” Ø¬Ø³ØªØ¬ÙˆÛŒ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ (Ú©Ø¯ Ø§Ù„Ø²Ø§Ù…ÛŒ)</h4>
  <input id="search" oninput="renderStores()">

  <div id="stores"></div>

  <button onclick="calc()">ğŸšš Ù…Ø­Ø§Ø³Ø¨Ù‡</button>

  <table>
   <thead>
    <tr><th>Ú©Ø¯</th><th>Ø´Ù‡Ø±</th><th>Ù…Ø³Ø¦ÙˆÙ„</th><th>km Ø±ÙØªâ€ŒÙˆØ¨Ø±Ú¯Ø´Øª</th></tr>
   </thead>
   <tbody id="out"></tbody>
  </table>

  <button onclick="logout()" style="background:#991b1b">Ø®Ø±ÙˆØ¬</button>
 </div>
 <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ========= ØªÙ†Ø¸ÛŒÙ…Ø§Øª ========= */
const CONFIG={
 user:"naser",
 pass:"12345",
 neshanKey:"service.2b2bc79d99084f40be64ee8e482a45ef"
};

/* ========= Ø¯Ø§Ø¯Ù‡ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ ========= */
const STORES=[
 {code:"1008",city:"ØªÙ‡Ø±Ø§Ù†",manager:"Ø§Ø­Ù…Ø¯ÛŒ",lat:35.6892,lng:51.3890},
 {code:"1010",city:"Ú©Ø±Ø¬",manager:"Ø±Ø¶Ø§ÛŒÛŒ",lat:35.8400,lng:50.9391},
 {code:"1020",city:"Ù‚Ù…",manager:"Ù…Ø­Ù…Ø¯ÛŒ",lat:34.6416,lng:50.8746}
];

let map,warehouseMarker,warehouse;

/* ========= LOGIN ========= */
function doLogin(){
 if(u.value===CONFIG.user && p.value===CONFIG.pass){
  localStorage.setItem("login","1");
  start();
 }else alert("Ø§Ø´ØªØ¨Ø§Ù‡");
}
document.addEventListener("keydown",e=>{
 if(e.key==="Enter") doLogin();
});
function logout(){
 localStorage.removeItem("login");
 location.reload();
}
function start(){
 login.style.display="none";
 app.style.display="flex";
 initMap();
 renderStores();
}
if(localStorage.getItem("login")==="1") start();

/* ========= MAP ========= */
function initMap(){
 map=L.map("map").setView([35.7,51.4],9);

 L.tileLayer(
  "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
  {maxZoom:19}
 ).addTo(map);

 map.on("click",e=>{
  warehouse=e.latlng;
  wh.value=warehouse.lat+","+warehouse.lng;
  if(warehouseMarker) map.removeLayer(warehouseMarker);
  warehouseMarker=L.marker(e.latlng).addTo(map).bindPopup("Ø§Ù†Ø¨Ø§Ø±").openPopup();
 });
}

/* ========= STORES ========= */
function renderStores(){
 stores.innerHTML="";
 const q=search.value;
 STORES.filter(s=>!q||s.code.includes(q)).forEach(s=>{
  stores.innerHTML+=`
   <div>
    <input type="checkbox" value="${s.code}">
    ${s.code} - ${s.city} - ${s.manager}
   </div>`;
 });
}

/* ========= ROUTE ========= */
function calc(){
 if(!warehouse){alert("Ø§Ù†Ø¨Ø§Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡");return;}
 out.innerHTML="";
 [...document.querySelectorAll("#stores input:checked")]
 .map(c=>STORES.find(s=>s.code===c.value))
 .forEach(s=>route(s));
}

function route(s){
 const url=`https://api.neshan.org/v4/direction?origin=${warehouse.lat},${warehouse.lng}&destination=${s.lat},${s.lng}&vehicle=truck`;
 fetch(url,{headers:{"Api-Key":CONFIG.neshanKey}})
 .then(r=>r.json())
 .then(d=>{
  const km=(d.routes[0].legs[0].distance.value/1000)*2;
  out.innerHTML+=`
   <tr>
    <td>${s.code}</td>
    <td>${s.city}</td>
    <td>${s.manager}</td>
    <td>${km.toFixed(1)}</td>
   </tr>`;
 });
}
</script>
</body>
</html>
