<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<title>naser.ir | Ø³Ø§Ù…Ø§Ù†Ù‡ Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ</title>

<link rel="stylesheet" href="https://static.neshan.org/sdk/leaflet/1.4.0/leaflet.css">
<script src="https://static.neshan.org/sdk/leaflet/1.4.0/leaflet.js"></script>

<style>
body{margin:0;font-family:tahoma;background:#0f172a;color:#e5e7eb}
header{height:56px;background:#020617;display:flex;align-items:center;padding:0 20px;font-weight:bold}
#login,#app{height:100vh;display:flex;align-items:center;justify-content:center}
.login-box{
  background:#020617;padding:30px;border-radius:12px;width:300px
}
.login-box input,button{
  width:100%;padding:10px;margin:8px 0;border-radius:6px;border:none
}
button{background:#2563eb;color:#fff;cursor:pointer}
button:hover{background:#1d4ed8}

.container{display:flex;height:calc(100vh - 56px)}
.sidebar{
  width:360px;background:#020617;padding:12px;overflow:auto
}
.sidebar h3{margin:10px 0}
.sidebar input,.sidebar select{width:100%;padding:8px;margin:6px 0;border-radius:6px;border:none}
.list{max-height:260px;overflow:auto;border:1px solid #1f2933}
.item{padding:6px;border-bottom:1px solid #1f2933}
#map{flex:1}
table{width:100%;border-collapse:collapse;background:#fff;color:#000}
th,td{border:1px solid #ddd;padding:6px;text-align:center}
th{background:#f1f5f9}
.results{padding:10px;background:#e5e7eb}
</style>
</head>

<body>

<div id="login">
  <div class="login-box">
    <h3 style="text-align:center">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ naser.ir</h3>
    <input id="user" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ">
    <input id="pass" type="password" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
    <button onclick="login()">ÙˆØ±ÙˆØ¯</button>
  </div>
</div>

<div id="app" style="display:none;flex-direction:column;width:100%">
<header>ğŸšš naser.ir | Ø³Ø§Ù…Ø§Ù†Ù‡ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ Ú©Ø§Ù…ÛŒÙˆÙ†</header>

<div class="container">
<aside class="sidebar">
  <h3>ğŸ“ Ø§Ù†Ø¨Ø§Ø±</h3>
  <input id="warehouseSearch" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¢Ø¯Ø±Ø³ Ø§Ù†Ø¨Ø§Ø±">
  <button onclick="searchWarehouse()">ÛŒØ§ÙØªÙ† Ø§Ù†Ø¨Ø§Ø±</button>

  <h3>ğŸª ÙÛŒÙ„ØªØ± ÙØ±ÙˆØ´Ú¯Ø§Ù‡â€ŒÙ‡Ø§</h3>
  <input id="fCode" placeholder="Ú©Ø¯ ÙØ±ÙˆØ´Ú¯Ø§Ù‡">
  <input id="fCity" placeholder="Ø´Ù‡Ø±">
  <input id="fManager" placeholder="Ù…Ø³Ø¦ÙˆÙ„ Ù…Ù†Ø·Ù‚Ù‡">
  <button onclick="renderStores()">Ø§Ø¹Ù…Ø§Ù„ ÙÛŒÙ„ØªØ±</button>

  <h3>ğŸ“‹ ÙØ±ÙˆØ´Ú¯Ø§Ù‡â€ŒÙ‡Ø§</h3>
  <div class="list" id="storeList"></div>

  <button onclick="calculateRoutes()">Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø³ÛŒØ±</button>
</aside>

<div id="map"></div>
</div>

<div class="results">
<table id="result">
<tr><th>Ú©Ø¯</th><th>Ø´Ù‡Ø±</th><th>Ø±ÙØªâ€ŒÙˆØ¨Ø±Ú¯Ø´Øª (km)</th></tr>
</table>
</div>
</div>

<script>
/* ====== ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù‚Ø§Ø¨Ù„ ØªØºÛŒÛŒØ± ====== */
const SITE_NAME="naser.ir";
let LOGIN_USER="naser";
let LOGIN_PASS="12345";
const API_KEY="API_KEY_Ù†Ø´Ø§Ù†";

/* ====== Ù„Ø§Ú¯ÛŒÙ† ====== */
function login(){
  if(user.value===LOGIN_USER && pass.value===LOGIN_PASS){
    login.style.display="none";
    app.style.display="flex";
    initMap();
  }else alert("Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª");
}

/* ====== Ø¯Ø§Ø¯Ù‡ ÙØ±ÙˆØ´Ú¯Ø§Ù‡â€ŒÙ‡Ø§ (Ø«Ø§Ø¨Øª Ø³ÛŒØ³ØªÙ…) ====== */
const STORES=[
  {code:1080,city:"ØªÙ‡Ø±Ø§Ù†",manager:"Ù…Ù†Ø·Ù‚Ù‡ 1",lat:35.732,lng:51.422},
  {code:1102,city:"Ú©Ø±Ø¬",manager:"Ø§Ù„Ø¨Ø±Ø²",lat:35.84,lng:50.97},
  {code:1205,city:"Ù‚Ù…",manager:"Ù…Ø±Ú©Ø²ÛŒ",lat:34.64,lng:50.88}
];

let map,warehouse;

/* ====== Ù†Ù‚Ø´Ù‡ ====== */
function initMap(){
  map=L.map("map",{key:API_KEY,center:[35.7,51.4],zoom:9});
  renderStores();
}

/* ====== Ø§Ù†Ø¨Ø§Ø± ====== */
async function searchWarehouse(){
  const q=warehouseSearch.value;
  const r=await fetch(
    `https://api.neshan.org/v1/search?term=${q}&lat=35.7&lng=51.4`,
    {headers:{'Api-Key':API_KEY}}
  );
  const d=await r.json();
  if(!d.items.length)return;
  warehouse={lat:d.items[0].location.y,lng:d.items[0].location.x};
  L.marker([warehouse.lat,warehouse.lng]).addTo(map).bindPopup("Ø§Ù†Ø¨Ø§Ø±").openPopup();
  map.setView([warehouse.lat,warehouse.lng],13);
}

/* ====== Ù„ÛŒØ³Øª ÙØ±ÙˆØ´Ú¯Ø§Ù‡ ====== */
function renderStores(){
  storeList.innerHTML="";
  STORES.filter(s=>
    (!fCode.value||s.code==fCode.value)&&
    (!fCity.value||s.city.includes(fCity.value))&&
    (!fManager.value||s.manager.includes(fManager.value))
  ).forEach(s=>{
    storeList.innerHTML+=`
      <div class="item">
        <label>
          <input type="checkbox" value="${s.code}">
          ${s.code} - ${s.city} - ${s.manager}
        </label>
      </div>`;
  });
}

/* ====== Ù…Ø³ÛŒØ± ====== */
async function calculateRoutes(){
  if(!warehouse)return alert("Ø§Ù†Ø¨Ø§Ø± Ù…Ø´Ø®Øµ Ù†Ø´Ø¯Ù‡");
  result.innerHTML="<tr><th>Ú©Ø¯</th><th>Ø´Ù‡Ø±</th><th>Ø±ÙØªâ€ŒÙˆØ¨Ø±Ú¯Ø´Øª (km)</th></tr>";
  const selected=[...document.querySelectorAll("input[type=checkbox]:checked")]
    .map(c=>STORES.find(s=>s.code==c.value));
  for(let s of selected){
    const r=await fetch(
      `https://api.neshan.org/v4/direction?type=truck&origin=${warehouse.lat},${warehouse.lng}&destination=${s.lat},${s.lng}`,
      {headers:{'Api-Key':API_KEY}}
    );
    const d=await r.json();
    const km=(d.routes[0].legs[0].distance.value*2/1000).toFixed(1);
    result.innerHTML+=`<tr><td>${s.code}</td><td>${s.city}</td><td>${km}</td></tr>`;
  }
}
</script>

</body>
</html>
