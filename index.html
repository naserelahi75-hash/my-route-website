<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>محاسبه بهره‌وری</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body { font-family: Tahoma; direction: rtl; padding: 20px; }
table { border-collapse: collapse; width: 100%; font-size: 12px; margin-top:20px;}
th,td { border:1px solid #ccc; padding:6px; text-align:center;}
th { background:#eee; }
</style>
</head>

<body>

<h2>محاسبه بهره‌وری (پاداش)</h2>

<input type="file" id="file" accept=".xlsx">
<button onclick="run()">محاسبه</button>
<button onclick="download()">دانلود خروجی</button>

<table id="tbl"></table>

<script>
let output = [];

function run() {
  const file = document.getElementById("file").files[0];
  if (!file) return alert("فایل را انتخاب کن");

  const reader = new FileReader();
  reader.onload = e => {
    const wb = XLSX.read(e.target.result, { type: "array" });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
    calculate(data);
    render();
  };
  reader.readAsArrayBuffer(file);
}

function calculate(data) {
  const header = data[0];
  const rows = data.slice(1);

  // ایندکس ستون‌ها (دقیق طبق فایل تو)
  const COL = {
    region: 0,
    code: 1,
    name: 2,
    position: 3,
    humanSide: 4,
    workDaysNow: 5,
    otPrev: 6,
    prodPrev: 7,
    factor: 8,
    otNow: 9,
    workDaysPrev: 10
  };

  // میانگین برای پرسنل جدید
  const avg = {};

  rows.forEach(r => {
    const key = r[COL.position] + "_" + r[COL.region];
    const prod = Number(r[COL.prodPrev]);
    if (!avg[key]) avg[key] = [];
    if (prod > 0) avg[key].push(prod);
  });

  const avgFinal = {};
  Object.keys(avg).forEach(k => {
    avgFinal[k] = avg[k].reduce((a,b)=>a+b,0) / avg[k].length;
  });

  output = rows.map(r => {
    let prevProd = Number(r[COL.prodPrev]);
    let prevDays = r[COL.workDaysPrev];

    // پرسنل جدید
    if (prevDays === "پرسنل جدید" || !prevProd) {
      const key = r[COL.position] + "_" + r[COL.region];
      prevProd = avgFinal[key] || 0;
      prevDays = r[COL.workDaysNow];
    }

    prevDays = Number(prevDays);
    const currDays = Number(r[COL.workDaysNow]);
    const factor = Number(r[COL.factor]);
    const otPrev = Number(r[COL.otPrev]) || 0;
    const otNow = Number(r[COL.otNow]) || 0;

    let base = 0;
    if (prevDays > 0)
      base = (prevProd / prevDays) * currDays * factor;

    let otEffect = 1;
    if (otPrev > 0)
      otEffect += ((otNow - otPrev) / otPrev) * 0.25;

    const final = Math.round(base * otEffect);

    return [...r, final];
  });

  header.push("بهره‌وری نهایی");
}

function render() {
  const t = document.getElementById("tbl");
  t.innerHTML = "";

  t.innerHTML += "<tr>" + output[0].map((_,i)=>`<th>${i===output[0].length-1?"بهره‌وری نهایی":""}</th>`).join("") + "</tr>";

  output.forEach(r=>{
    t.innerHTML += "<tr>" + r.map(x=>`<td>${x}</td>`).join("") + "</tr>";
  });
}

function download() {
  const ws = XLSX.utils.aoa_to_sheet(output);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Result");
  XLSX.writeFile(wb, "بهره‌وری_نهایی.xlsx");
}
</script>

</body>
</html>
