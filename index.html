<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>مسیریابی کامیون</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
  body { margin:0; font-family:tahoma; }
  #map { height:100vh; width:100%; }

  .panel {
    position:absolute;
    top:20px;
    left:20px;
    background:#111827;
    color:#fff;
    padding:15px;
    border-radius:12px;
    width:280px;
    z-index:1000;
  }

  input, button {
    width:100%;
    margin-top:8px;
    padding:8px;
    border-radius:6px;
    border:none;
  }

  button {
    background:#2563eb;
    color:#fff;
    cursor:pointer;
  }
</style>
</head>
<body>

<div class="panel">
  <div>مبدا (lat,lng)</div>
  <input id="origin" placeholder="35.6892,51.3890">

  <div>مقصد (lat,lng)</div>
  <input id="destination" placeholder="35.7503,51.4756">

  <button onclick="routeTruck()">محاسبه مسیر کامیون</button>

  <small>کلیک اول: مبدا | کلیک دوم: مقصد</small>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const API_KEY = "service.2b2bc79d99084f40be64ee8e482a45ef";

const map = L.map('map').setView([35.6892,51.3890], 11);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19
}).addTo(map);

let markers = [];
let routeLine = null;
let clickCount = 0;

map.on('click', e => {
  const coord = `${e.latlng.lat.toFixed(6)},${e.latlng.lng.toFixed(6)}`;

  if (clickCount === 0) {
    document.getElementById("origin").value = coord;
  } else {
    document.getElementById("destination").value = coord;
  }

  markers.push(L.marker(e.latlng).addTo(map));
  clickCount = (clickCount + 1) % 2;
});

async function routeTruck() {
  const origin = document.getElementById("origin").value;
  const destination = document.getElementById("destination").value;

  if (!origin || !destination) {
    alert("مبدا و مقصد را مشخص کن");
    return;
  }

  if (routeLine) map.removeLayer(routeLine);

  const url = `https://api.neshan.org/v4/direction?type=truck&origin=${origin}&destination=${destination}`;

  const res = await fetch(url, {
    headers: {
      "Api-Key": API_KEY
    }
  });

  const data = await res.json();

  const coords = data.routes[0].legs[0].steps.flatMap(s =>
    s.polyline.map(p => [p[1], p[0]])
  );

  routeLine = L.polyline(coords, {
    color: 'orange',
    weight: 6
  }).addTo(map);

  map.fitBounds(routeLine.getBounds());
}
</script>

</body>
</html>
