<script>
function toNumber(v) {
  if (v === undefined || v === null || v === "" || isNaN(v)) return 0;
  return Number(String(v).replace(/,/g, ""));
}

function calculate(rows) {
  let total = 0;

  rows.forEach(r => {
    // ستون‌ها بر اساس موقعیت واقعی اکسل
    const prevProductivity = toNumber(r["EMPTY_7__"]); // بهره‌وری ماه قبل
    const workDays         = toNumber(r["EMPTY_5__"]); // تعداد روز کاری ماه جاری
    const factor           = toNumber(r["EMPTY_8__"]); // ضریب بهره‌وری
    const otPrev           = toNumber(r["EMPTY_6__"]); // اضافه‌کاری ماه قبل
    const otCurrent        = toNumber(r["EMPTY_9__"]); // اضافه‌کاری ماه جاری
    const rate             = toNumber(r["EMPTY_11__"]); // نرخ محاسبه

    // بهره‌وری پایه
    const daily = prevProductivity / 30;
    const baseProductivity = daily * workDays * factor;

    // منطق معکوس اضافه‌کاری
    const deltaOT = otPrev - otCurrent;
    const otEffect = deltaOT * rate;

    const finalValue = Math.round(baseProductivity + otEffect);

    r["محاسبه بهره‌وری ماه جدید"] = finalValue;
    total += finalValue;
  });

  document.getElementById("budget").innerText =
    "جمع کل بودجه بهره‌وری: " + total.toLocaleString();

  return rows;
}
</script>
