<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crop Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„</title>

<style>
body{font-family:tahoma;background:#f5f5f5;padding:15px}
canvas{
  max-width:100%;
  border:1px solid #ccc;
  touch-action:none;
}
input,button{
  width:100%;
  padding:10px;
  margin-top:10px;
}
</style>
</head>
<body>

<h3>Ú©Ø±Ø§Ù¾ ØªØµÙˆÛŒØ± (Ø®Ø·â€ŒÚ†ÛŒÙ† Ù¾Ø±Ø±Ù†Ú¯)</h3>

<input type="file" id="fileInput" accept="image/*">

<canvas id="canvas"></canvas>

<label>Ú©ÛŒÙÛŒØª Ø®Ø±ÙˆØ¬ÛŒ</label>
<input type="range" id="quality" min="0.3" max="1" step="0.1" value="0.9">

<button id="save">Ø°Ø®ÛŒØ±Ù‡ ØªØµÙˆÛŒØ±</button>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const fileInput = document.getElementById('fileInput');
const quality = document.getElementById('quality');

let img = new Image();
let crop = {x:0,y:0,w:0,h:0};
let draggingCorner = null;

// Ù…Ù†Ø§Ø³Ø¨ Ù„Ù…Ø³
const cornerSize = 26;

// ---------- Draw ----------
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(img,0,0);

  // Ú©Ø§Ø¯Ø± Ø®Ø·â€ŒÚ†ÛŒÙ† Ù¾Ø±Ø±Ù†Ú¯
  ctx.save();
  ctx.strokeStyle="rgba(0,0,0,0.85)";
  ctx.lineWidth=4;
  ctx.setLineDash([14,10]);
  ctx.strokeRect(crop.x,crop.y,crop.w,crop.h);
  ctx.restore();

  drawCorner(crop.x,crop.y);
  drawCorner(crop.x+crop.w,crop.y);
  drawCorner(crop.x,crop.y+crop.h);
  drawCorner(crop.x+crop.w,crop.y+crop.h);
}

function drawCorner(x,y){
  ctx.fillStyle="#fff";
  ctx.strokeStyle="#000";
  ctx.lineWidth=3;
  ctx.beginPath();
  ctx.arc(x,y,cornerSize/2,0,Math.PI*2);
  ctx.fill();
  ctx.stroke();
}

function getPos(e){
  const r=canvas.getBoundingClientRect();
  const t=e.touches?e.touches[0]:e;
  return {x:t.clientX-r.left,y:t.clientY-r.top};
}

function hit(x,y,cx,cy){
  return Math.hypot(x-cx,y-cy) < cornerSize;
}

// ---------- Load Image ----------
fileInput.onchange=e=>{
  const reader=new FileReader();
  reader.onload=ev=>{
    img.onload=()=>{
      canvas.width=img.width;
      canvas.height=img.height;

      // ğŸ”¥ Ú©Ø±Ø§Ù¾ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ = Û¸Û°Ùª ØªØµÙˆÛŒØ± (ÙˆØ³Ø·)
      const w = img.width * 0.8;
      const h = img.height * 0.8;
      crop = {
        x:(img.width-w)/2,
        y:(img.height-h)/2,
        w,h
      };
      draw();
    }
    img.src=ev.target.result;
  }
  reader.readAsDataURL(e.target.files[0]);
}

// ---------- Interaction ----------
canvas.onmousedown = canvas.ontouchstart = e=>{
  const p=getPos(e);
  const {x,y,w,h}=crop;

  if(hit(p.x,p.y,x,y)) draggingCorner="tl";
  else if(hit(p.x,p.y,x+w,y)) draggingCorner="tr";
  else if(hit(p.x,p.y,x,y+h)) draggingCorner="bl";
  else if(hit(p.x,p.y,x+w,y+h)) draggingCorner="br";
}

canvas.onmousemove = canvas.ontouchmove = e=>{
  if(!draggingCorner) return;
  const p=getPos(e);

  if(draggingCorner==="tl"){
    crop.w+=crop.x-p.x; crop.h+=crop.y-p.y;
    crop.x=p.x; crop.y=p.y;
  }
  if(draggingCorner==="tr"){
    crop.w=p.x-crop.x; crop.h+=crop.y-p.y;
    crop.y=p.y;
  }
  if(draggingCorner==="bl"){
    crop.w+=crop.x-p.x;
    crop.x=p.x; crop.h=p.y-crop.y;
  }
  if(draggingCorner==="br"){
    crop.w=p.x-crop.x; crop.h=p.y-crop.y;
  }
  draw();
}

canvas.onmouseup = canvas.ontouchend = ()=> draggingCorner=null;

// ---------- Save ----------
document.getElementById('save').onclick=()=>{
  const t=document.createElement('canvas');
  t.width=crop.w; t.height=crop.h;
  t.getContext('2d').drawImage(
    canvas,
    crop.x,crop.y,crop.w,crop.h,
    0,0,crop.w,crop.h
  );
  const a=document.createElement('a');
  a.href=t.toDataURL('image/jpeg',quality.value);
  a.download="crop.jpg";
  a.click();
}
</script>

</body>
</html>
