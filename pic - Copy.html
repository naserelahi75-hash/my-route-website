<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ویرایش تصویر موبایل</title>
<style>
body{font-family:tahoma;background:#f5f5f5;padding:15px}
input,button{width:100%;margin-top:10px;padding:10px}
canvas{max-width:100%;border:1px solid #ccc;margin-top:10px;touch-action:none}
</style>
</head>
<body>

<h3>آپلود و کراپ تصویر (موبایل)</h3>

<input type="file" id="fileInput" accept="image/*">

<canvas id="canvas"></canvas>

<label>کیفیت خروجی</label>
<input type="range" id="quality" min="0.3" max="1" step="0.1" value="0.8">

<button id="save">ذخیره</button>

<script>
const fileInput = document.getElementById('fileInput');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const quality = document.getElementById('quality');

let img = new Image();
let sx, sy, ex, ey, dragging=false;

fileInput.onchange = e => {
  const reader = new FileReader();
  reader.onload = ev => {
    img.onload = () => {
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img,0,0);
    }
    img.src = ev.target.result;
  }
  reader.readAsDataURL(e.target.files[0]);
}

// Touch + Mouse
function pos(e){
  const r=canvas.getBoundingClientRect();
  const t=e.touches?e.touches[0]:e;
  return {x:t.clientX-r.left,y:t.clientY-r.top};
}

canvas.onmousedown = canvas.ontouchstart = e=>{
  dragging=true;
  const p=pos(e); sx=p.x; sy=p.y;
}

canvas.onmousemove = canvas.ontouchmove = e=>{
  if(!dragging) return;
  const p=pos(e); ex=p.x; ey=p.y;
  ctx.drawImage(img,0,0);
  ctx.strokeStyle="red";
  ctx.strokeRect(sx,sy,ex-sx,ey-sy);
}

canvas.onmouseup = canvas.ontouchend = ()=> dragging=false;

document.getElementById('save').onclick=()=>{
  if(!ex||!ey) return alert("ناحیه را انتخاب کنید");
  const w=ex-sx,h=ey-sy;
  const t=document.createElement('canvas');
  t.width=w;t.height=h;
  t.getContext('2d').drawImage(canvas,sx,sy,w,h,0,0,w,h);
  const a=document.createElement('a');
  a.href=t.toDataURL('image/jpeg',quality.value);
  a.download="image.jpg";a.click();
}
</script>

</body>
</html>
