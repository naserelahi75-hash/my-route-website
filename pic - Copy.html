<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crop Dual Mode</title>

<style>
body{font-family:tahoma;background:#f5f5f5;padding:15px}
canvas{
  max-width:100%;
  border:1px solid #ccc;
  background:#fff;
}
input,button{
  width:100%;
  padding:10px;
  margin-top:10px;
}
</style>
</head>
<body>

<h3>Crop تصویر (Desktop / Mobile)</h3>

<input type="file" id="fileInput" accept="image/*">
<canvas id="canvas"></canvas>
<button id="save">ذخیره</button>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const fileInput = document.getElementById('fileInput');

const isMobile = /iPhone|iPad|Android/i.test(navigator.userAgent);

let img = new Image();
let crop = {};
let activeCorner = null;

// ---------- Init ----------
fileInput.onchange = e=>{
  const r = new FileReader();
  r.onload = ev=>{
    img.onload = ()=>{
      canvas.width = img.width;
      canvas.height = img.height;

      // 80% center crop
      const w = img.width * 0.8;
      const h = img.height * 0.8;
      crop = {
        x:(img.width-w)/2,
        y:(img.height-h)/2,
        w,h
      };
      draw();
    };
    img.src = ev.target.result;
  };
  r.readAsDataURL(e.target.files[0]);
};

// ---------- Draw ----------
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(img,0,0);

  if(isMobile){
    // Mobile: solid thick
    ctx.strokeStyle="rgba(0,0,0,0.9)";
    ctx.lineWidth=5;
    ctx.strokeRect(crop.x,crop.y,crop.w,crop.h);
  } else {
    // Desktop: dashed
    ctx.strokeStyle="red";
    ctx.lineWidth=2;
    ctx.setLineDash([8,6]);
    ctx.strokeRect(crop.x,crop.y,crop.w,crop.h);
    ctx.setLineDash([]);
  }

  drawHandle(crop.x,crop.y);
  drawHandle(crop.x+crop.w,crop.y);
  drawHandle(crop.x,crop.y+crop.h);
  drawHandle(crop.x+crop.w,crop.y+crop.h);
}

function drawHandle(x,y){
  ctx.fillStyle="#fff";
  ctx.strokeStyle="#000";
  ctx.lineWidth=2;
  ctx.beginPath();
  ctx.arc(x,y,isMobile?18:10,0,Math.PI*2);
  ctx.fill();
  ctx.stroke();
}

// ---------- Utils ----------
function hit(p,x,y){
  const r = isMobile ? 28 : 12;
  return Math.hypot(p.x-x,p.y-y) < r;
}

function posMouse(e){
  const r=canvas.getBoundingClientRect();
  return {x:e.clientX-r.left,y:e.clientY-r.top};
}

function posTouch(e){
  e.preventDefault();
  const r=canvas.getBoundingClientRect();
  const t=e.touches[0];
  return {x:t.clientX-r.left,y:t.clientY-r.top};
}

// ---------- Desktop Events ----------
canvas.addEventListener('mousedown',e=>{
  if(isMobile) return;
  const p=posMouse(e);
  const {x,y,w,h}=crop;
  if(hit(p,x,y)) activeCorner="tl";
  else if(hit(p,x+w,y)) activeCorner="tr";
  else if(hit(p,x,y+h)) activeCorner="bl";
  else if(hit(p,x+w,y+h)) activeCorner="br";
});

canvas.addEventListener('mousemove',e=>{
  if(isMobile || !activeCorner) return;
  updateCrop(posMouse(e));
});

canvas.addEventListener('mouseup',()=>activeCorner=null);

// ---------- Mobile Events ----------
canvas.addEventListener('touchstart',e=>{
  if(!isMobile) return;
  const p=posTouch(e);
  const {x,y,w,h}=crop;
  if(hit(p,x,y)) activeCorner="tl";
  else if(hit(p,x+w,y)) activeCorner="tr";
  else if(hit(p,x,y+h)) activeCorner="bl";
  else if(hit(p,x+w,y+h)) activeCorner="br";
},{passive:false});

canvas.addEventListener('touchmove',e=>{
  if(!isMobile || !activeCorner) return;
  updateCrop(posTouch(e));
},{passive:false});

canvas.addEventListener('touchend',()=>activeCorner=null);

// ---------- Crop Update ----------
function updateCrop(p){
  if(activeCorner==="tl"){
    crop.w+=crop.x-p.x; crop.h+=crop.y-p.y;
    crop.x=p.x; crop.y=p.y;
  }
  if(activeCorner==="tr"){
    crop.w=p.x-crop.x; crop.h+=crop.y-p.y;
    crop.y=p.y;
  }
  if(activeCorner==="bl"){
    crop.w+=crop.x-p.x;
    crop.x=p.x; crop.h=p.y-crop.y;
  }
  if(activeCorner==="br"){
    crop.w=p.x-crop.x; crop.h=p.y-crop.y;
  }
  draw();
}

// ---------- Save ----------
document.getElementById('save').onclick=()=>{
  const t=document.createElement('canvas');
  t.width=crop.w; t.height=crop.h;
  t.getContext('2d').drawImage(
    canvas,
    crop.x,crop.y,crop.w,crop.h,
    0,0,crop.w,crop.h
  );
  const a=document.createElement('a');
  a.href=t.toDataURL('image/jpeg',0.9);
  a.download="crop.jpg";
  a.click();
};
</script>

</body>
</html>
