<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crop حرفه‌ای iOS</title>

<style>
body{font-family:tahoma;background:#f5f5f5;padding:15px}
canvas{
  max-width:100%;
  border:1px solid #ccc;
  touch-action:none;
}
input,button{width:100%;padding:10px;margin-top:10px}
</style>
</head>
<body>

<h3>کراپ تصویر (بهینه Safari)</h3>

<input type="file" id="fileInput" accept="image/*">
<canvas id="canvas"></canvas>

<button id="save">ذخیره</button>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const fileInput = document.getElementById('fileInput');

let img = new Image();
let crop = {};
let dragging = null;

// Retina Fix
function resizeCanvas(w,h){
  const dpr = window.devicePixelRatio || 1;
  canvas.width = w * dpr;
  canvas.height = h * dpr;
  canvas.style.width = w + "px";
  canvas.style.height = h + "px";
  ctx.setTransform(dpr,0,0,dpr,0,0);
}

// Draw
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(img,0,0);

  // کادر ضخیم (بهتر از خط‌چین در iOS)
  ctx.strokeStyle="rgba(0,0,0,0.9)";
  ctx.lineWidth=5;
  ctx.strokeRect(crop.x,crop.y,crop.w,crop.h);

  // inner stroke
  ctx.strokeStyle="rgba(255,255,255,0.9)";
  ctx.lineWidth=2;
  ctx.strokeRect(crop.x+2,crop.y+2,crop.w-4,crop.h-4);

  drawCorner(crop.x,crop.y);
  drawCorner(crop.x+crop.w,crop.y);
  drawCorner(crop.x,crop.y+crop.h);
  drawCorner(crop.x+crop.w,crop.y+crop.h);
}

function drawCorner(x,y){
  ctx.fillStyle="#fff";
  ctx.strokeStyle="#000";
  ctx.lineWidth=3;
  ctx.beginPath();
  ctx.arc(x,y,18,0,Math.PI*2);
  ctx.fill();ctx.stroke();
}

function pos(e){
  e.preventDefault();
  const r=canvas.getBoundingClientRect();
  const t=e.touches?e.touches[0]:e;
  return {x:t.clientX-r.left,y:t.clientY-r.top};
}

function hit(p,cx,cy){
  return Math.hypot(p.x-cx,p.y-cy)<28;
}

// Load
fileInput.onchange=e=>{
  const r=new FileReader();
  r.onload=ev=>{
    img.onload=()=>{
      resizeCanvas(img.width,img.height);

      const w=img.width*0.8,h=img.height*0.8;
      crop={x:(img.width-w)/2,y:(img.height-h)/2,w,h};
      draw();
    }
    img.src=ev.target.result;
  }
  r.readAsDataURL(e.target.files[0]);
}

// Touch Events (optimized)
canvas.addEventListener('touchstart',e=>{
  const p=pos(e);
  const {x,y,w,h}=crop;
  if(hit(p,x,y)) dragging="tl";
  else if(hit(p,x+w,y)) dragging="tr";
  else if(hit(p,x,y+h)) dragging="bl";
  else if(hit(p,x+w,y+h)) dragging="br";
},{passive:false});

canvas.addEventListener('touchmove',e=>{
  if(!dragging) return;
  const p=pos(e);
  if(dragging==="tl"){
    crop.w+=crop.x-p.x; crop.h+=crop.y-p.y;
    crop.x=p.x; crop.y=p.y;
  }
  if(dragging==="tr"){
    crop.w=p.x-crop.x; crop.h+=crop.y-p.y;
    crop.y=p.y;
  }
  if(dragging==="bl"){
    crop.w+=crop.x-p.x;
    crop.x=p.x; crop.h=p.y-crop.y;
  }
  if(dragging==="br"){
    crop.w=p.x-crop.x; crop.h=p.y-crop.y;
  }
  requestAnimationFrame(draw);
},{passive:false});

canvas.addEventListener('touchend',()=>dragging=null);

// Save
document.getElementById('save').onclick=()=>{
  const t=document.createElement('canvas');
  t.width=crop.w; t.height=crop.h;
  t.getContext('2d').drawImage(
    canvas,crop.x,crop.y,crop.w,crop.h,0,0,crop.w,crop.h
  );
  const a=document.createElement('a');
  a.href=t.toDataURL('image/jpeg',0.9);
  a.download="crop.jpg";a.click();
}
</script>

</body>
</html>
