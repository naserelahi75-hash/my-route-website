<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Image Crop – Clean Rewrite</title>

<style>
body{
  font-family:tahoma;
  background:#f5f5f5;
  padding:15px;
}
canvas{
  max-width:100%;
  background:#fff;
  border:1px solid #ccc;
  touch-action:none;
}
.controls{
  margin:10px 0;
}
.controls label{
  display:block;
  margin-top:8px;
  font-size:14px;
}
.controls input{
  width:100%;
}
button{
  width:100%;
  padding:10px;
  margin-top:10px;
}
</style>
</head>
<body>

<h3>کراپ تصویر (ورژن تخمی)</h3>

<input type="file" id="fileInput" accept="image/*">

<div class="controls">
  <label>اندازه نقطه‌چین</label>
  <input type="range" id="dashSize" min="6" max="40" value="18">
</div>

<canvas id="canvas"></canvas>

<button id="save">ذخیره تصویر</button>

<script>
// ======================
// Environment
// ======================
const isMobile = window.matchMedia("(pointer: coarse)").matches;

// ======================
// Canvas
// ======================
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

// ======================
// Controls
// ======================
const dashInput = document.getElementById('dashSize');
const fileInput = document.getElementById('fileInput');

// ======================
// Image & Crop State
// ======================
let img = new Image();
let crop = {x:0,y:0,w:0,h:0};

// Interaction
let mode = null; // tl,tr,bl,br,move
let last = null;

// Handle sizes
const HANDLE_VISIBLE_RADIUS = isMobile ? 10 : 8;
const HANDLE_HIT_RADIUS     = isMobile ? 40 : 26;

// ======================
// Helpers
// ======================
function getPos(e){
  const r = canvas.getBoundingClientRect();
  const p = e.touches ? e.touches[0] : e;
  return {x:p.clientX - r.left, y:p.clientY - r.top};
}

function hitHandle(p, x, y){
  return Math.hypot(p.x - x, p.y - y) <= HANDLE_HIT_RADIUS;
}

function insideCrop(p){
  return (
    p.x > crop.x &&
    p.x < crop.x + crop.w &&
    p.y > crop.y &&
    p.y < crop.y + crop.h
  );
}

function clamp(){
  crop.w = Math.max(60, crop.w);
  crop.h = Math.max(60, crop.h);
  crop.x = Math.max(0, Math.min(crop.x, canvas.width  - crop.w));
  crop.y = Math.max(0, Math.min(crop.y, canvas.height - crop.h));
}

// ======================
// Draw
// ======================
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(img,0,0);

  // Dark outside
  ctx.save();
  ctx.fillStyle = "rgba(0,0,0,0.45)";
  ctx.beginPath();
  ctx.rect(0,0,canvas.width,canvas.height);
  ctx.rect(crop.x,crop.y,crop.w,crop.h);
  ctx.fill("evenodd");
  ctx.restore();

  const dash = parseInt(dashInput.value);

  if(isMobile){
    // Safari-safe dashed simulation
    ctx.strokeStyle = "#000";
    ctx.lineWidth = 4;

    for(let x=crop.x; x<crop.x+crop.w; x+=dash*2){
      ctx.beginPath();
      ctx.moveTo(x,crop.y);
      ctx.lineTo(x+dash,crop.y);
      ctx.stroke();

      ctx.beginPath();
      ctx.moveTo(x,crop.y+crop.h);
      ctx.lineTo(x+dash,crop.y+crop.h);
      ctx.stroke();
    }

    for(let y=crop.y; y<crop.y+crop.h; y+=dash*2){
      ctx.beginPath();
      ctx.moveTo(crop.x,y);
      ctx.lineTo(crop.x,y+dash);
      ctx.stroke();

      ctx.beginPath();
      ctx.moveTo(crop.x+crop.w,y);
      ctx.lineTo(crop.x+crop.w,y+dash);
      ctx.stroke();
    }
  }else{
    // Desktop real dashed
    ctx.strokeStyle = "red";
    ctx.lineWidth = 2;
    ctx.setLineDash([dash, dash*0.7]);
    ctx.strokeRect(crop.x,crop.y,crop.w,crop.h);
    ctx.setLineDash([]);
  }

  drawHandles();
}

function drawHandles(){
  const r = HANDLE_VISIBLE_RADIUS;
  const points = [
    [crop.x, crop.y],
    [crop.x+crop.w, crop.y],
    [crop.x, crop.y+crop.h],
    [crop.x+crop.w, crop.y+crop.h]
  ];

  points.forEach(p=>{
    ctx.beginPath();
    ctx.fillStyle="#fff";
    ctx.strokeStyle="#000";
    ctx.lineWidth=2;
    ctx.arc(p[0], p[1], r, 0, Math.PI*2);
    ctx.fill();
    ctx.stroke();
  });
}

// ======================
// Interaction Detection
// ======================
function detectMode(p){
  const x=crop.x, y=crop.y, w=crop.w, h=crop.h;

  if(hitHandle(p,x,y)) return "tl";
  if(hitHandle(p,x+w,y)) return "tr";
  if(hitHandle(p,x,y+h)) return "bl";
  if(hitHandle(p,x+w,y+h)) return "br";
  if(insideCrop(p)) return "move";

  return null;
}

// ======================
// Events
// ======================
function start(e){
  const p = getPos(e);
  mode = detectMode(p);
  last = p;
}

function move(e){
  if(!mode) return;
  const p = getPos(e);

  if(mode === "move"){
    crop.x += p.x - last.x;
    crop.y += p.y - last.y;
  }else{
    if(mode==="br"){ crop.w = p.x - crop.x; crop.h = p.y - crop.y; }
    if(mode==="tr"){ crop.w = p.x - crop.x; crop.h += crop.y - p.y; crop.y = p.y; }
    if(mode==="bl"){ crop.w += crop.x - p.x; crop.x = p.x; crop.h = p.y - crop.y; }
    if(mode==="tl"){ crop.w += crop.x - p.x; crop.h += crop.y - p.y; crop.x = p.x; crop.y = p.y; }
  }

  clamp();
  last = p;
  draw();
}

function end(){
  mode = null;
}

// Desktop
canvas.addEventListener("mousedown", e=>{ if(isMobile) return; start(e); });
canvas.addEventListener("mousemove", e=>{ if(isMobile) return; move(e); });
canvas.addEventListener("mouseup", end);

// Mobile
canvas.addEventListener("touchstart", e=>{ if(!isMobile) return; e.preventDefault(); start(e); }, {passive:false});
canvas.addEventListener("touchmove", e=>{ if(!isMobile) return; e.preventDefault(); move(e); }, {passive:false});
canvas.addEventListener("touchend", end);

// ======================
// Load Image
// ======================
fileInput.onchange = e=>{
  const r = new FileReader();
  r.onload = ev=>{
    img.onload = ()=>{
      canvas.width = img.width;
      canvas.height = img.height;

      const w = img.width * 0.8;
      const h = img.height * 0.8;
      crop = {
        x:(img.width-w)/2,
        y:(img.height-h)/2,
        w,h
      };
      draw();
    };
    img.src = ev.target.result;
  };
  r.readAsDataURL(e.target.files[0]);
};

// ======================
// Save
// ======================
document.getElementById("save").onclick = ()=>{
  const t = document.createElement("canvas");
  t.width = crop.w;
  t.height = crop.h;
  t.getContext("2d").drawImage(
    canvas,
    crop.x,crop.y,crop.w,crop.h,
    0,0,crop.w,crop.h
  );
  const a = document.createElement("a");
  a.href = t.toDataURL("image/jpeg",0.9);
  a.download = "crop.jpg";
  a.click();
};
</script>

</body>
</html>
