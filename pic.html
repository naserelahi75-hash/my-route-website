<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <title>آپلود، کراپ و کاهش حجم تصویر</title>
  <style>
    body { font-family: Tahoma, sans-serif; background:#f5f5f5; padding:20px }
    .dropzone {
      border: 2px dashed #888;
      padding: 30px;
      text-align: center;
      background: #fff;
      cursor: pointer;
      margin-bottom: 20px;
    }
    .dropzone.dragover { border-color: #007bff; background:#eef5ff }
    .preview { max-width: 100%; }
    .controls { margin-top: 15px }
    label { display:block; margin-top:10px }
    button { margin-top:15px; padding:8px 16px }
    canvas { max-width:100%; border:1px solid #ccc }
  </style>
</head>
<body>

<h2>آپلود تصویر با Drag & Drop + کراپ و کاهش حجم</h2>

<div class="dropzone" id="dropzone">
  تصویر را بکشید و اینجا رها کنید یا کلیک کنید
  <input type="file" id="fileInput" accept="image/*" hidden>
</div>

<div>
  <canvas id="canvas"></canvas>
</div>

<div class="controls">
  <label>
    کیفیت تصویر (برای کاهش حجم):
    <input type="range" id="quality" min="0.1" max="1" step="0.1" value="0.8">
  </label>

  <label>
    عرض خروجی (px):
    <input type="number" id="outputWidth" placeholder="مثلاً 800">
  </label>

  <button id="saveBtn">ذخیره تصویر</button>
</div>

<script>
const dropzone = document.getElementById('dropzone');
const fileInput = document.getElementById('fileInput');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const qualityInput = document.getElementById('quality');
const outputWidthInput = document.getElementById('outputWidth');

let img = new Image();
let startX, startY, endX, endY, isDragging = false;

// Drag & Drop
dropzone.addEventListener('click', () => fileInput.click());

dropzone.addEventListener('dragover', e => {
  e.preventDefault();
  dropzone.classList.add('dragover');
});

dropzone.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));

dropzone.addEventListener('drop', e => {
  e.preventDefault();
  dropzone.classList.remove('dragover');
  loadFile(e.dataTransfer.files[0]);
});

fileInput.addEventListener('change', e => loadFile(e.target.files[0]));

function loadFile(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    img.onload = () => {
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img, 0, 0);
    }
    img.src = e.target.result;
  }
  reader.readAsDataURL(file);
}

// Crop with mouse
canvas.addEventListener('mousedown', e => {
  startX = e.offsetX;
  startY = e.offsetY;
  isDragging = true;
});

canvas.addEventListener('mousemove', e => {
  if (!isDragging) return;
  endX = e.offsetX;
  endY = e.offsetY;
  ctx.drawImage(img, 0, 0);
  ctx.strokeStyle = 'red';
  ctx.strokeRect(startX, startY, endX - startX, endY - startY);
});

canvas.addEventListener('mouseup', () => isDragging = false);

// Save
saveBtn.addEventListener('click', () => {
  const cropWidth = endX - startX;
  const cropHeight = endY - startY;

  if (!cropWidth || !cropHeight) {
    alert('ابتدا ناحیه کراپ را انتخاب کنید');
    return;
  }

  const outputWidth = parseInt(outputWidthInput.value) || cropWidth;
  const scale = outputWidth / cropWidth;
  const outputHeight = cropHeight * scale;

  const tempCanvas = document.createElement('canvas');
  tempCanvas.width = outputWidth;
  tempCanvas.height = outputHeight;
  const tctx = tempCanvas.getContext('2d');

  tctx.drawImage(
    canvas,
    startX, startY, cropWidth, cropHeight,
    0, 0, outputWidth, outputHeight
  );

  const dataUrl = tempCanvas.toDataURL('image/jpeg', parseFloat(qualityInput.value));

  const a = document.createElement('a');
  a.href = dataUrl;
  a.download = 'image.jpg';
  a.click();
});
</script>

</body>
</html>
